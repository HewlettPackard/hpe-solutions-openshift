### **Adding RH CoreOS Worker Nodes to Existing Openshift Cluster**

This section covers the steps to Enable KVM hypervisor on Worker Nodes and add RHCOS worker VM nodes to an existing Red Hat OpenShift Container Platform cluster.

1. Login to the Rhel 8.6 Installer VM (that we created as a part of rhel8_installerVM.yml -- it would have been created as one KVM VM on one of the head nodes)

2. Navigate to the directory $BASE_DIR(**/opt/Openshift-Synergy-RA-LTI-OCP-4.12/DL-LTI-Openshift/**) then copy **input file and hosts** file to $BASE_DIR/coreos_kvmworker_nodes/ and later update ocp worker details in input file and kvm_workernodes group as per sample host file. 

```
ansible-vault edit input.yaml
```
```
vi hosts
	'[kvm_workernodes]
	KVMworker1 IP
	KVMworker2 IP
	KVMworker3 IP'
```
**NOTE**
ansible vault password is **changeme**

3. Execute the following command to add the worker nodes to the cluster

           'ansible-playbook -i hosts site.yaml --ask-vault-pass'

In case, if user want to deploy through individual playbooks. Sequence of playbooks to be followed are:

		   'ansible-playbook -i hosts playbooks/rhel8_os_deployment.yml
		    ansible-playbook -i hosts playbooks/copy_ssh_workernode.yml
			ansible-playbook -i hosts playbooks/prepare_rhel_hosts.yml
			ansible-playbook -i hosts playbooks/ntp.yml
			ansible-playbook -i hosts playbooks/binddns.yml
			ansible-playbook -i hosts playbooks/haproxy.yml
			ansible-playbook -i hosts playbooks/storage_pool.yml
			ansible-playbook -i hosts playbooks/deploy_ipxe_ocp.yml
			ansible-playbook -i hosts playbooks/ocp_rhcosworkervm.yml'


### **Playbook description**

**site.yml**

-   This playbook contains the script to enable KVM hypervisor on Worker Nodes and adds RHCOS worker VM nodes to an existing Red Hat OpenShift Container Platform cluster

**rhel8_os_deployment.yml**

- This playbook contains the scripts to deploy rhel8.6 OS on baremetal servers.

**copy_ssh_workernode.yml**

-   This playbook contains the script to copy the ssh public key from installer machine to the KVM worker nodes.

**prepare_rhel_hosts.yml**

-   This playbook contains the script to prepare KVM worker nodes with required packages and subscription.

**ntp.yml**

-   This playbook contains the script to create NTP setup on KVM worker nodes to make sure time synchronization.

**binddns.yml**

-   This playbook contains the script to deploy bind dns on three head nodes and it will work as both Active & Passive.

**haproxy.yml**

-   This playbook contains the script to deploy haproxy on the head nodes and it will act as Active.

**storage_pool.yml**

-   This playbook contains the script to create the storage pools on the KVM Worker nodes.

**deploy_ipxe_ocp.yml**

-   This playbook contains the script to deploy the ipxe code on the RHEL8 installer machine.

**ocp_rhcosworkervm.yml**

-   This playbook contains the script to add kvm based coreos nodes to exsting Openshift cluster.

After successful execution of all playbooks, check the node status as below.

** Approving server certificates (CSR) for newly added nodes **

The administrator needs to approve the CSR requests generated by each kubelet.

You can approve all Pending CSR requests using below command

        '$ oc get csr -o json | jq -r '.items[] | select(.status == {} ) | .metadata.name' | xargs oc adm certificate approve '
		
Later, Verify Node status using below command

         '$ oc get nodes'

Execute the following command to set the parameter **mastersSchedulable** parameter as **false**, so that master nodes will not be used to schedule pods.

         '$ oc edit scheduler'

