# HPE deployment guide for integrating Aquasecurity's open-source tool kube-bench with the Red Hat OpenShift Container Platform on the HPE Synergy

Prior to using the instructions in this README.md file it is recommended that you read and understand the deployment guide found at https://github.com/hewlettpackard/hpe-solutions-openshift/tree/master/synergy/scalable/nimble. Instructions found in the deployment guide will take precedence over instructions in README.md files.

________________________________________
## About ##
________________________________________

This repo contains Ansible plays and scripts to automate the installation of kube-bench over the Red Hat OpenShift 3.11 nodes.

Contents of the repo are:

**playbooks:** This folder contains the playbook required for kube-bench installtion over ocp 3.11.

**roles:** This folder contains a role called "kube-bench-deploy-ocp" which is responsible for performing the actions required for kube-bench integration.

**hosts:** This is the host file which will be used by Ansible Engine to reference hosts during kube-bench deployment. Provide the OCP master nodes, worker nodes and infra nodes complete host name in this file

**site.yaml:** In this file we import playbook "kube-bench-deployment.yaml" that defines our entire workflow for kube-bench integration.

________________________________________
## Prerequisites ##
________________________________________
 
 - Red Hat OpenShift 3.11 is up and running.

 - All the nodes in in Red Hat OpenShift 3.11 deployment are virtual nodes with RHEL 7.6.

 - User has access to the internet to clone public github repository for kube-bench on each node of OpenShift

 - User has access to the internet to clone public github repository for golang dependencies on each node of OpenShift
 
________________________________________
## Custom Attributes\Variable Files and plays ##
________________________________________
	
Each playbook has a role associated with it. Each role has a set of tasks under "task" folder and variables under "var" folder. These variable values need to be defined by the user according to the installer’s environment before running the plays.
These variable values need to be defined by the user according to the installer’s environment before running the plays.

**security-kube-bench/roles/kube-bench-deploy-ocp/tasks/main.yml**

This file contains the automated steps for golang, kube-bench, running kube-bench and storing results back to ansible engine node

________________________________________
## How to use ##
________________________________________

Step1 : Clone this repo to the Ansible Engine host using the below command
```
git clone https://github.com/hewlettpackard/hpe-solutions-openshift
```

Step2 : From the Ansible Engine command prompt, browse tho the clone directory
```
Openshift-Synergy-RA\synergy\scalable\security-kube-bench
```

Step3 : Open and edit the "hosts" file in an editor by typing following command:
```
vi hosts
```

Step4 : Then run the play using following commands
```
ansible-playbook -i hosts site.yml
``` 

Step5: On the ansible engine browse the "/tmp/" directory and check all the log files generated from each of masters, workers and infra nodes specified in hosts file is available in the directory
```
cd /tmp
```

Output:
Log file generated by kube-bench on each node under test of the OCP infrastrcuture will give details of security issues and warnings generated by testing the OpenShift containers against CIS benchmark.

_______________________________________
## Summary ##
________________________________________
These scripts have been tested on OCP 3.11 and after successful installation and running of kube-bench, a report is generated showcasing container security issues identified on each node of OCP.

OCP Nodes/VM run on Red Hat Enterprise Linux 7.6

Virtualization hosts version: Red Hat Virtualization Host 4.2

Virtualization Manager version: Red Hat Virtualization Manager 4.2

Ansible Engine Version: Red Hat Ansible Engine 2.5

Python: 2.7.x

OCP version: Red Hat OpenShift Container Platform 3.11
