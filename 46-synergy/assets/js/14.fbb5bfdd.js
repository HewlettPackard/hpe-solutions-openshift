(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{385:function(e,a,t){e.exports=t.p+"assets/img/Figure131.8418facb.png"},386:function(e,a,t){e.exports=t.p+"assets/img/Figure132.c6f24e7a.png"},387:function(e,a,t){e.exports=t.p+"assets/img/Figure133.d590723d.png"},388:function(e,a,t){e.exports=t.p+"assets/img/Figure134.76306db4.png"},389:function(e,a,t){e.exports=t.p+"assets/img/Figure135.5c5befeb.png"},525:function(e,a,t){"use strict";t.r(a);var s=t(42),r=Object(s.a)({},(function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"install-and-configure-velero"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-and-configure-velero"}},[e._v("#")]),e._v(" Install and Configure Velero")]),e._v(" "),s("h2",{attrs:{id:"introduction"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#introduction"}},[e._v("#")]),e._v(" Introduction")]),e._v(" "),s("p",[e._v("Velero is an open source tool to safely backup and restore, perform\ndisaster recovery, and migrate Kubernetes cluster resources and\npersistent volumes. It works both on premises and in a public cloud.\nVelero consists of a server process running as a deployment in your\nKubernetes cluster and a command-line interface (CLI) with which DevOps\nteams and platform operators configure scheduled backups, trigger ad-hoc\nbackups, perform restores, and more.")]),e._v(" "),s("p",[e._v("Unlike other tools which directly access the Kubernetes etcd database to\nperform backups and restores, Velero uses the Kubernetes API to capture\nthe state of cluster resources and to restore them when necessary. This\nAPI-driven approach has a number of key benefits:")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("Backups can capture subsets of the cluster's resources, filtering by\nnamespace, resource type, and/or label selector, providing a high\ndegree of flexibility around what's backed up and restored.")])]),e._v(" "),s("li",[s("p",[e._v("Users of managed Kubernetes offerings often do not have access to\nthe underlying etc")])]),e._v(" "),s("li",[s("p",[e._v("d database, so direct backups/restores of it are not possible.")])]),e._v(" "),s("li",[s("p",[e._v("Resources exposed through aggregated API servers can easily be\nbacked up and restored even if they're stored in a separate etcd\ndatabase")])])]),e._v(" "),s("p",[e._v("Velero provides a suite of tools to backup Kubernetes resources and\napplications for two main purposes:")]),e._v(" "),s("ul",[s("li",[s("p",[s("strong",[e._v("Disaster Recovery")]),e._v(" -- Recover Kubernetes cluster components and\napplications.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Migration")]),e._v(" -- Migrate your Kubernetes applications to another\nKubernetes cluster.")])]),e._v(" "),s("li",[s("p",[s("strong",[e._v("Data Protection")]),e._v(" - Offers key data protection features such as\nscheduled backups, retention schedules, and pre or post-backup hooks\nfor custom actions.")])])]),e._v(" "),s("p",[s("img",{attrs:{src:t(385),alt:""}})]),e._v(" "),s("p",[s("strong",[e._v("Figure 131.")]),e._v(" Installing and Configure Velero Solution Layout")]),e._v(" "),s("p",[e._v("Velero lets you:")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("Take backups of your cluster and restore in case of loss.")])]),e._v(" "),s("li",[s("p",[e._v("Migrate cluster resources to other clusters.")])]),e._v(" "),s("li",[s("p",[e._v("Replicate your production cluster to development and testing\nclusters.")])])]),e._v(" "),s("p",[e._v("Velero consists of:")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("A server that runs on your cluster")])]),e._v(" "),s("li",[s("p",[e._v("A command-line client that runs locally")])])]),e._v(" "),s("p",[e._v("This section covers how to install and configure Velero and how to use\nVelero to take backup/restore on an Openshift Container Platform by\nusing noobaa object storage.")]),e._v(" "),s("h2",{attrs:{id:"flow-diagram"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#flow-diagram"}},[e._v("#")]),e._v(" Flow Diagram")]),e._v(" "),s("p",[s("img",{attrs:{src:t(386),alt:""}})]),e._v(" "),s("p",[s("strong",[e._v("Figure 132.")]),e._v(" Installing and Configuring Velero Solution Flow Diagram")]),e._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[e._v("PREREQUISITES")]),e._v(" "),s("p",[e._v("OpenShift Container Platform cluster should be available with the\nadministrator credentials")]),e._v(" "),s("p",[e._v("OCP cluster should have noobaa object storage as part of Openshift\nStorage cluster")])]),e._v(" "),s("h2",{attrs:{id:"installation-process"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#installation-process"}},[e._v("#")]),e._v(" Installation Process")]),e._v(" "),s("p",[s("strong",[e._v("Follow below steps to retrieve Nooba information.")])]),e._v(" "),s("ol",[s("li",[s("p",[e._v("Login to the ocp cluster and describe the noobaa pod to get the\nexternal DNS")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" oc describe noobaa -n openshift-storage\n")])])])]),e._v(" "),s("li",[s("p",[e._v("Get the noobaa access ID & KEY by running bellow command")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" kubectl get secret noobaa-admin -n openshift-storage -o json "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" jq\n"),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'.data|map_values(@base64d)'")]),e._v("\n")])])]),s("p",[s("img",{attrs:{src:t(387),alt:""}})])]),e._v(" "),s("li",[s("p",[e._v("Once we have noobaa information, create credential file in cluster\nas shown below:")]),e._v(" "),s("p",[e._v("Create file by running following command")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[e._v("vi")]),e._v(" velero.credentials\n")])])]),s("p",[e._v("Add content into the file as mentioned below:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('\n[default]\n\naws_access_key_id = "3vTNl90sOpX654VdQYQm"\n\naws_secret_access_key = "L0q2juZc647ySGRTHNzalmA2qKXK+fdkHV"\n\n')])])])])]),e._v(" "),s("p",[s("strong",[e._v("Follow below steps to configure Velero with Nooba storage.")])]),e._v(" "),s("ol",[s("li",[s("p",[e._v("Create a separate directory for Velero configuration and switch into\nthat directory.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("mkdir")]),e._v(" --p ~/Velero\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" ~/Velero\n")])])])]),e._v(" "),s("li",[s("p",[e._v("Download and install Velero client by using below steps")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("wget")]),e._v("\nhttps://github.com/vmware-tanzu/velero/releases/download/v1.5.1/velero-v1.5.1-linux-amd64.tar.gz\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("tar")]),e._v(" zxf velero-v1.5.1-linux-amd64.tar.gz\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("mv")]),e._v(" velero-v1.5.1-linux-amd64/Velero /usr/local/bin/\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("rm")]),e._v(" -rf velero*\n\n")])])])]),e._v(" "),s("li",[s("p",[e._v("Generate a certificate using the below command.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" openssl s_client -showcerts "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v(" \n-servername s3-openshift-storage.apps.dev01.twentynet.local "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n-connect s3-openshift-storage.apps.dev01.twentynet.local:443\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[s("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[e._v("2")]),e._v(">")]),e._v("/dev/null "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("|")]),e._v(" openssl x509 -inform pem "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" /tmp/noobaa.crt\n\n")])])])]),e._v(" "),s("li",[s("p",[e._v("To configure Velero server by using noobaa storage run the following\ncommand:")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[e._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" velero "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n\n--provider aws "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n\n--plugins velero/velero-plugin-for-aws:v1.1.0 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n\n--bucket velerobucket1 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n\n--secret-file ./noobaa.credentials "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n\n--use-volume-snapshots"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("false --use-restic --default-volumes-to-restic\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n\n--backup-location-config\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("region")]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("noobaa,s3ForcePathStyle"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true,s3Url"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("https://s3-openshift-storage.apps.dev0.twentynet.local\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("\\")]),e._v("\n\n--cacert"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/tmp/noobaa.crt\n\n")])])]),s("p",[e._v("Output of the above command:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("\nClusterRoleBinding/velero: already exists, proceeding\n\nClusterRoleBinding/velero: created\n\nServiceAccount/velero: attempting to create resource\n\nServiceAccount/velero: created\n\nSecret/cloud-credentials: attempting to create resource\n\nSecret/cloud-credentials: created\n\nBackupStorageLocation/default: attempting to create resource\n\nBackupStorageLocation/default: created\n\nDeployment/velero: attempting to create resource\n\nDeployment/velero: created\n\nVelero is installed! â›µ Use 'kubectl logs deployment/velero -n velero'\nto view the status.\n\n")])])])])]),e._v(" "),s("p",[s("strong",[e._v("Enable Velero Pods")])]),e._v(" "),s("ol",[s("li",[s("p",[e._v("Execute the below commands for creating velero pods.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" oc adm policy add-scc-to-user privileged -z velero -n velero\n\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" oc patch ds/restic --namespace velero --type json -p\n"),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('\'[{"op":"add","path":"/spec/template/spec/containers/0/securityContext","value":\n{ "privileged": true}}]\'')]),e._v("\n\n")])])])]),e._v(" "),s("li",[s("p",[e._v("Velero pods should be Running and use the below command to check\nvelero pods status.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("watch")]),e._v(" oc get pods --n velero\n")])])])])]),e._v(" "),s("p",[s("strong",[e._v("Follow below steps for backup and restore.")])]),e._v(" "),s("ol",[s("li",[s("p",[e._v("Below figure shows wordpress app resources under project wordpress")]),e._v(" "),s("p",[s("img",{attrs:{src:t(388),alt:""}})])]),e._v(" "),s("li",[s("p",[e._v("Run the following command to take backup")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" velero backup create wpbackup --include-namespaces wordpress\n")])])]),s("p",[e._v("Output of the above command:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('Backup request "my-backup" submitted successfully.\nRun `velero backup describe wpbackup` or `velero backup logs\nwpbackup` for more details.\n')])])])]),e._v(" "),s("li",[s("p",[e._v("After few seconds, run the below command to check the backup status.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" velero backup describe wpbackup\n")])])])]),e._v(" "),s("li",[s("p",[e._v("Run below command to get available backups in Velero.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" velero backup get\n")])])]),s("p",[e._v("Output of the above command:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("NAME STATUS ERRORS WARNINGS CREATED EXPIRES STORAGE LOCATION SELECTOR\nwpbackup Completed 0 0 2020-09-29 14:38:36 +0200 CEST 29d default\n<none>\n")])])])]),e._v(" "),s("li",[s("p",[e._v("Run the below command to restore the backup in Velero.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" velero restore create --from-backup wpbackup\n")])])]),s("p",[e._v("Output of the above command:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('Restore request "wpbackup-20200930065552" submitted successfully.\nRun `velero restore describe wpbackup-20200930065552` or `velero\nrestore logs wpbackup-20200930065552` for more details.\n')])])])]),e._v(" "),s("li",[s("p",[e._v("Run the below command to list the restore.")]),e._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" velero restore get\n")])])]),s("p",[e._v("Output of the above command.")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("NAME BACKUP STATUS STARTED COMPLETED ERRORS WARNINGS CREATED SELECTOR\nwpbackup-20200930065552 wpbackup Completed 2020-09-30 06:55:51 +0200\nCEST 2020-09-30 06:55:53 +0200 CEST 0 0 2020-09-30 06:55:52 +0200 CEST\n<none>\n\n")])])])])]),e._v(" "),s("h2",{attrs:{id:"verification"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#verification"}},[e._v("#")]),e._v(" Verification")]),e._v(" "),s("p",[e._v("Verify wordpress resources got restored or not.")]),e._v(" "),s("p",[s("img",{attrs:{src:t(389),alt:""}})])])}),[],!1,null,null,null);a.default=r.exports}}]);