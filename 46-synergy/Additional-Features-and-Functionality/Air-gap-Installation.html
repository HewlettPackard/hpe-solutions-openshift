<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Red Hat OpenShift Container Platform installation in the restricted network environment | OpenShift Container Platform 4.4 on Synergy</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Hewlett Packard Enterprise">
    
    <link rel="preload" href="/hpe-solutions-openshift/46-synergy/assets/css/0.styles.bfdf2f8a.css" as="style"><link rel="preload" href="/hpe-solutions-openshift/46-synergy/assets/js/app.8d09024b.js" as="script"><link rel="preload" href="/hpe-solutions-openshift/46-synergy/assets/js/2.117ef8fd.js" as="script"><link rel="preload" href="/hpe-solutions-openshift/46-synergy/assets/js/11.eb22f408.js" as="script"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/10.f2647a7a.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/12.c2b1bda3.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/13.b2721807.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/14.fbb5bfdd.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/15.076cb55f.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/16.086f907f.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/17.5044d63c.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/18.0138d6da.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/19.577c768d.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/20.5dab068a.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/21.ea4d33a2.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/22.23d6a92d.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/23.329f64c2.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/24.bad0d82d.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/25.2a05a77a.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/26.05687ea8.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/27.5f97f9ba.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/28.9f8648b2.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/29.ffe26d0e.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/3.643f6564.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/30.b6d944bc.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/31.b0b75d1f.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/32.4d1ff1fb.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/33.da67f8dd.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/34.78fab925.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/35.5e384204.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/36.53dec668.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/37.e773d372.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/4.7110e26d.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/5.8d6b47a1.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/6.b3a62cb0.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/7.a921eaba.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/8.8b92de32.js"><link rel="prefetch" href="/hpe-solutions-openshift/46-synergy/assets/js/9.7e00b22b.js">
    <link rel="stylesheet" href="/hpe-solutions-openshift/46-synergy/assets/css/0.styles.bfdf2f8a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/hpe-solutions-openshift/46-synergy/" class="home-link router-link-active"><!----> <span class="site-name">OpenShift Container Platform 4.4 on Synergy</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/hpe-solutions-openshift/46-synergy/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="http://www.hpe.com/info/ra" target="_blank" rel="noopener noreferrer" class="nav-link external">
  RA Library
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/hpe-solutions-openshift/46-synergy/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="http://www.hpe.com/info/ra" target="_blank" rel="noopener noreferrer" class="nav-link external">
  RA Library
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Red Hat OpenShift Container Platform 4 on HPE Synergy</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Solution Overview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Solution Components</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Solution Deployment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Additional Features and Functionality</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Storage.html" class="sidebar-link">Storage</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/IPI-Installation.html" class="sidebar-link">IPI deployment of OCP on Bare Metal</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html" aria-current="page" class="active sidebar-link">Red Hat OpenShift Container Platform installation in the restricted network environment</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#solution-components-overview" class="sidebar-link">Solution components overview</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#flow-of-execution" class="sidebar-link">Flow of Execution</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#download-server" class="sidebar-link">Download server</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#centos-7-internal-yum-server" class="sidebar-link">CentOS 7 internal Yum Server</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#mirror-registry-internal-registry" class="sidebar-link">Mirror registry (Internal registry)</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#dns-entries" class="sidebar-link">DNS entries</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#load-balance-server-with-haproxy" class="sidebar-link">Load balance server with HAProxy</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#installer-machine" class="sidebar-link">Installer machine</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#openshift-cluster-nodes" class="sidebar-link">Openshift cluster nodes</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#ipxe-server" class="sidebar-link">iPXE server</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#red-hat-openshift-container-platform-cluster-installation" class="sidebar-link">Red Hat OpenShift Container Platform Cluster Installation</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#snapshots" class="sidebar-link">Snapshots</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#setup-centos-servers-to-use-internal-yum-server" class="sidebar-link">Setup centos servers to use internal yum server</a></li><li class="sidebar-sub-header"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#using-operator-lifecycle-manager-on-restricted-networks" class="sidebar-link">Using Operator Lifecycle Manager on Restricted Networks</a></li></ul></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/OpenShift-operators.html" class="sidebar-link">OpenShift operators</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Integration-with-Prometheus.html" class="sidebar-link">Integration of HPE OneView with Prometheus</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Sysdig-Secure.html" class="sidebar-link">Securing Red Hat OpenShift Container Platform using Sysdig Secure and Sysdig Monitor</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Physical-worker-node-labeling.html" class="sidebar-link">Physical worker node labeling in Red Hat OpenShift cluster</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Advanced-Cluster-Management.html" class="sidebar-link">Red Hat Advanced Cluster Management for Kubernetes</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Install-and-Configure-Velero.html" class="sidebar-link">Install and Configure Velero</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Ceph-Storage-Setup-ExternalMode.html" class="sidebar-link">Red Hat Ceph Storage 4 Setup in External mode with OCS Integration</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Openshift-Virtualization.html" class="sidebar-link">OpenShift Virtualization</a></li><li><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Validating-OCP-Deployment.html" class="sidebar-link">Validating OpenShift Container Platform deployment</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Resosurces and Additional Links</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="red-hat-openshift-container-platform-installation-in-the-restricted-network-environment"><a href="#red-hat-openshift-container-platform-installation-in-the-restricted-network-environment" class="header-anchor">#</a> Red Hat OpenShift Container Platform installation in the restricted network environment</h1> <h2 id="solution-components-overview"><a href="#solution-components-overview" class="header-anchor">#</a> Solution components overview</h2> <ol><li><p>Download server</p></li> <li><p>Centos Yum repository server</p></li> <li><p>OpenShift Mirror registry</p></li> <li><p>Installer machine</p></li> <li><p>iPXE server</p></li> <li><p>Load balancer</p></li> <li><p>OpenShift cluster nodes</p> <ul><li><p>Bootstrap node</p></li> <li><p>Master nodes</p></li> <li><p>Worker nodes</p></li></ul></li></ol> <p><img src="/hpe-solutions-openshift/46-synergy/assets/img/Figure81.95309061.png" alt=""></p> <p><strong>Figure 81.</strong> Air-gap installation architecture</p> <h2 id="flow-of-execution"><a href="#flow-of-execution" class="header-anchor">#</a> Flow of Execution</h2> <p><img src="/hpe-solutions-openshift/46-synergy/assets/img/Figure82.ef0c6655.png" alt=""> <strong>Figure 82</strong>. Air-gap insallation Solution Flow Diagram</p> <h2 id="download-server"><a href="#download-server" class="header-anchor">#</a> Download server</h2> <p>Download server is the server which has conditional internet access and
is used to built on virtual machine with the following configurations</p> <ol><li><p>OS - CentOS 7 with preinstalled packages such as &quot;Development
Tools&quot;, &quot;Compatibility Libraries&quot;, &quot;System Administration
Tools&quot;</p></li> <li><p>CPU - 4 vCPU</p></li> <li><p>Memory - 8 GB</p></li> <li><p>Disk - 300 GB free space in the / partition</p></li> <li><p>Network adapter - 1 network adapter with connectivity to the
production network</p></li></ol> <h3 id="for-the-yum-repository-server"><a href="#for-the-yum-repository-server" class="header-anchor">#</a> For the Yum repository server</h3> <ol><li>Download the necessary RPM packages for yum-utils, epel-release,
createrepo and nginx and zip them to a tar file</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">mkdir</span> -p /opt/hpe/solutions/hpe-solutions-openshift/rpms

<span class="token operator">&gt;</span> yum -y <span class="token function">install</span> <span class="token function">wget</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /opt/hpe/solutions/hpe-solutions-openshift/rpms

<span class="token operator">&gt;</span> <span class="token function">wget</span> http://mirror.centos.org/centos/7/os/x86_64/Packages/createrepo-0.9.9-28.el7.noarch.rpm

<span class="token operator">&gt;</span> <span class="token function">wget</span> http://nginx.org/packages/mainline/centos/7/x86_64/RPMS/nginx-1.9.9-1.el7.ngx.x86_64.rpm
</code></pre></div><p>Delta RPM (optional -&gt; if minimal installation is done)</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">wget</span> http://mirror.centos.org/centos/7/os/x86_64/Packages/deltarpm-3.6-3.el7.x86_64.rpm
</code></pre></div><p>Python Delta RPM (optional -&gt; if minimal installation is done)</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">wget</span> http://mirror.centos.org/centos/7/os/x86_64/Packages/python-deltarpm-3.6-3.el7.x86_64.rpm

<span class="token operator">&gt;</span> <span class="token function">tar</span> -zcf centos-rpms.tar.gz *
</code></pre></div><ol start="2"><li>Download the base, extras, centosplus and updates repo to the
destination download directory</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">mkdir</span> -p /opt/hpe/solutions/hpe-solutions-openshift/yum_repos

<span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /opt/hpe/solutions/hpe-solutions-openshift/yum_repos

<span class="token operator">&gt;</span> yum -y <span class="token function">install</span> epel-release createrepo yum-utils reposync

<span class="token operator">&gt;</span> reposync --gpgcheck -l --repoid<span class="token operator">=</span>base
--download_path<span class="token operator">=</span>/opt/hpe/solutions/hpe-solutions-openshift/yum_repos
--downloadcomps --download-metadata

<span class="token operator">&gt;</span> reposync --gpgcheck -l --repoid<span class="token operator">=</span>extras
--download_path<span class="token operator">=</span>/opt/hpe/solutions/hpe-solutions-openshift/yum_repos
--downloadcomps --download-metadata

<span class="token operator">&gt;</span> reposync --gpgcheck -l --repoid<span class="token operator">=</span>updates
--download_path<span class="token operator">=</span>/opt/hpe/solutions/hpe-solutions-openshift/yum_repos
--downloadcomps --download-metadata

<span class="token operator">&gt;</span> reposync --gpgcheck -l --repoid<span class="token operator">=</span>centosplus
--download_path<span class="token operator">=</span>/opt/hpe/solutions/hpe-solutions-openshift/yum_repos
--downloadcomps --download-metadata

<span class="token operator">&gt;</span> <span class="token function">tar</span> -zvcf centos-yum-repository.tar.gz *
</code></pre></div><ol start="3"><li>Securely transfer the zipped files to the server to be used as a yum
repository server</li></ol> <h3 id="for-the-mirror-registry"><a href="#for-the-mirror-registry" class="header-anchor">#</a> For the mirror registry</h3> <ol><li>Create the directories needed for the mirror repository</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">mkdir</span> -p /opt/hpe/solutions/hpe-solutions-openshift/registry

<span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">REGISTRY_BASE</span><span class="token operator">=</span><span class="token string">&quot;/opt/hpe/solutions/hpe-solutions-openshift/registry&quot;</span>

<span class="token operator">&gt;</span> <span class="token function">mkdir</span> -p <span class="token variable">${REGISTRY_BASE}</span>/<span class="token punctuation">{</span>auth,certs,data,downloads<span class="token punctuation">}</span>

<span class="token operator">&gt;</span> <span class="token function">mkdir</span> -p <span class="token variable">${REGISTRY_BASE}</span>/downloads/<span class="token punctuation">{</span>images,tools,secrets<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Set the hostname of the server and update the hostname of the
external server in the &quot;hosts&quot; file:</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> hostnamectl set-hostname <span class="token operator">&lt;</span>registry_hostname<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> <span class="token function">vi</span> /etc/hosts

 <span class="token number">127.0</span>.0.1 <span class="token operator">&lt;</span>registry_hostname<span class="token operator">&gt;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Registry_hostname refers to common hostname/FQDN of the download
servers and the internal mirror registry.</p> <p>It is not necessary to create the DNS entry of the download server.</p></div> <ol start="3"><li>Download the necessary packages</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span>  yum <span class="token function">install</span> -y jq openssl podman p7zip httpd-tools <span class="token function">curl</span> <span class="token function">wget</span> <span class="token function">screen</span>
nmap telnet <span class="token function">ftp</span> tftp openldap-clients tcpdump wireshark xorg-x11-xauth
tmux net-tools nfs-utils sg3_utils bind-utils rlwrap uucp
</code></pre></div><ol start="4"><li>Generating the self-signed certificate '</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">${REGISTRY_BASE}</span>/certs/

<span class="token operator">&gt;</span> <span class="token function">cat</span> <span class="token operator">&gt;</span>csr_answer.txt <span class="token operator">&lt;&lt;</span> EOF

 <span class="token punctuation">[</span>req<span class="token punctuation">]</span>

 default_bits <span class="token operator">=</span> <span class="token number">4096</span>

 prompt <span class="token operator">=</span> no

 default_md <span class="token operator">=</span> sha256

 distinguished_name <span class="token operator">=</span> dn

 <span class="token punctuation">[</span> dn <span class="token punctuation">]</span>

 <span class="token assign-left variable">C</span><span class="token operator">=</span>US

 <span class="token assign-left variable">ST</span><span class="token operator">=</span>New York

 <span class="token assign-left variable">L</span><span class="token operator">=</span>New York

 <span class="token assign-left variable">O</span><span class="token operator">=</span>MyOrg

 <span class="token assign-left variable">OU</span><span class="token operator">=</span>MyOU

 <span class="token assign-left variable">emailAddress</span><span class="token operator">=</span>**<span class="token operator">&lt;</span>email_address<span class="token operator">&gt;</span>**

 CN <span class="token operator">=</span> **<span class="token operator">&lt;</span>replace with registry server hostname/FQDN. This is same as
 the internal mirror registry hostname/FQDN<span class="token operator">&gt;</span>**

 EOF
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> openssl req -newkey rsa:4096 -nodes -sha256 -keyout domain.key -x509
-days <span class="token number">365</span> -out domain.crt -config <span class="token operator">&lt;</span><span class="token punctuation">(</span> <span class="token function">cat</span> csr_answer.txt <span class="token punctuation">)</span>
</code></pre></div><ol start="5"><li>List and verify the generated self-signed certificate - there would
be domain.crt and domain.key files within the
${REGISTRY_BASE}/certs/ directory.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> ll <span class="token variable">${REGISTRY_BASE}</span>/certs/
</code></pre></div><ol start="6"><li>Generate the credentials to access the registry</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> htpasswd -bBc <span class="token variable">${REGISTRY_BASE}</span>/auth/htpasswd myuser mypassword
</code></pre></div><ol start="7"><li>Open firewall port 5000 to enable accessing the registry</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">FIREWALLD_DEFAULT_ZONE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>firewall-cmd --get-default-zone<span class="token variable">`</span></span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$FIREWALLD_DEFAULT_ZONE</span>

<span class="token operator">&gt;</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">5000</span>/tcp --zone<span class="token operator">=</span><span class="token variable">$FIREWALLD_DEFAULT_ZONE</span>
--permanent

<span class="token operator">&gt;</span> firewall-cmd --reload
</code></pre></div><ol start="8"><li>Create/Run the registry container</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> podman run --name my-registry --rm -d -p <span class="token number">5000</span>:5000 <span class="token punctuation">\</span>

 -v <span class="token variable">${REGISTRY_BASE}</span>/data:/var/lib/registry:z <span class="token punctuation">\</span>

 -v <span class="token variable">${REGISTRY_BASE}</span>/auth:/auth:z -e <span class="token string">&quot;REGISTRY_AUTH=htpasswd&quot;</span> <span class="token punctuation">\</span>

 -e <span class="token string">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry&quot;</span> <span class="token punctuation">\</span>

 -e <span class="token string">&quot;REGISTRY_HTTP_SECRET=ALongRandomSecretForRegistry&quot;</span> <span class="token punctuation">\</span>

 -e <span class="token assign-left variable">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="token operator">=</span>/auth/htpasswd <span class="token punctuation">\</span>

 -v <span class="token variable">${REGISTRY_BASE}</span>/certs:/certs:z <span class="token punctuation">\</span>

 -e <span class="token assign-left variable">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="token operator">=</span>/certs/domain.crt <span class="token punctuation">\</span>

 -e <span class="token assign-left variable">REGISTRY_HTTP_TLS_KEY</span><span class="token operator">=</span>/certs/domain.key <span class="token punctuation">\</span>

 docker.io/library/registry:2
</code></pre></div><ol start="9"><li>Verify connectivity to your registry with curl. Provide it the
username and password you created.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">curl</span> -u myuser:mypassword -k
</code></pre></div><p>This should return an &quot;empty&quot; repository for now</p> <div class="language- extra-class"><pre class="language-text"><code> {&quot;repositories&quot;:[]}
</code></pre></div><ol start="10"><li>Syncing the repositories</li></ol> <p>Export the OCP Release version</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">OCP_RELEASE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/release.txt<span class="token variable">)</span></span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Name:'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$NF</span>}'</span><span class="token punctuation">)</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;export OCP_RELEASE=<span class="token variable">${OCP_RELEASE}</span>&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/env_ocp
</code></pre></div><p>Download openshift client tool</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">wget</span> https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux-<span class="token variable">${OCP_RELEASE}</span>.tar.gz -P <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/
</code></pre></div><p>Untar the openshift client tool and create a soft link</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">tar</span> -xzf <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/openshift-client-linux-<span class="token variable">${OCP_RELEASE}</span>.tar.gz -C <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/

<span class="token operator">&gt;</span> <span class="token function">ln</span> -s <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/oc /usr/local/bin/oc
</code></pre></div><p>Retrieve and create the necessary pull secrets/credentials files</p> <ul><li>Navigate to the ${REGISTRY_BASE}/downloads/secrets/</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">${REGISTRY_BASE}</span>/downloads/secrets/
</code></pre></div><ul><li><p>Login to the Red Hat account and Navigate to the <a href="https://cloud.redhat.com/openshift/install/pull-secret" target="_blank" rel="noopener noreferrer">https://cloud.redhat.com/openshift/install/pull-secret<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>Create a file for the copied pull-secret and validate the same</p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">cat</span> <span class="token operator">&gt;</span> pull-secret.json <span class="token operator">&lt;&lt;</span> EOF

 <span class="token operator">&lt;</span>Copied-pull-secret<span class="token operator">&gt;</span>

 EOF

<span class="token operator">&gt;</span> <span class="token function">cat</span> pull-secret.json <span class="token operator">|</span> jq
</code></pre></div><ul><li>Generate a base64 output from the user+password string</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> -n <span class="token string">'myuser:mypassword'</span> <span class="token operator">|</span> base64 -w0

<span class="token operator">&gt;</span> <span class="token assign-left variable">REG_SECRET</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">echo</span> -n <span class="token string">'myuser:mypassword'</span> <span class="token operator">|</span> base64 -w0<span class="token variable">`</span></span>
</code></pre></div><ul><li>Create a bundle json file with all the registries and validate the
same</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">cat</span> pull-secret.json <span class="token operator">|</span> jq <span class="token string">'.auths +=
{&quot;&lt;registry_server_fqdn&gt;:5000&quot;: {&quot;auth&quot;:
&quot;REG_SECRET&quot;,&quot;email&quot;: &quot;**&lt;email_address&gt;**&quot;}}'</span> <span class="token operator">|</span> <span class="token function">sed</span>
<span class="token string">&quot;s/REG_SECRET/<span class="token variable">$REG_SECRET</span>/&quot;</span> <span class="token operator">&gt;</span> pull-secret-bundle.json

<span class="token operator">&gt;</span> <span class="token function">cat</span> pull-secret-bundle.json <span class="token operator">|</span> jq
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Update the &lt;registry_server_fqdn&gt; field in the above command and all
the subsequent occurances of similar flag with the fully qualified
domain name of the registry server as per the DNS entry. Update the
&lt;email_address&gt; field with the email address used during the
certificate creation.</p></div> <ul><li>Create a json file specifically for the mirror registry and validate
the same</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">'{ &quot;auths&quot;: {}}'</span> <span class="token operator">|</span> jq <span class="token string">'.auths +=
 {&quot;&lt;registry_server_fqdn&gt;:5000&quot;: {&quot;auth&quot;:
 &quot;REG_SECRET&quot;,&quot;email&quot;: &quot;**&lt;email_address&gt;**&quot;}}'</span> <span class="token operator">|</span> <span class="token function">sed</span>
 <span class="token string">&quot;s/REG_SECRET/<span class="token variable">$REG_SECRET</span>/&quot;</span> <span class="token operator">|</span> jq -c .<span class="token operator">&gt;</span> pull-secret-registry.json

<span class="token operator">&gt;</span> <span class="token function">cat</span> pull-secret-registry.json <span class="token operator">|</span> jq
</code></pre></div><ul><li>Trust the self-signed certificate generated earlier</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">cp</span> <span class="token variable">${REGISTRY_BASE}</span>/certs/domain.crt
 /etc/pki/ca-trust/source/anchors/

<span class="token operator">&gt;</span> update-ca-trust extract
</code></pre></div><p>Export a few more variable for the mirroring process and write them
into the environment variables file which can be later used to source</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">LOCAL_REGISTRY</span><span class="token operator">=</span><span class="token string">'&lt;registry_server_fqdn&gt;:5000'</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">OCP_RELEASE</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${OCP_RELEASE}</span>-x86_64&quot;</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">LOCAL_REPOSITORY</span><span class="token operator">=</span><span class="token string">'ocp/openshift4'</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">PRODUCT_REPO</span><span class="token operator">=</span><span class="token string">'openshift-release-dev'</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">LOCAL_SECRET_JSON</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${REGISTRY_BASE}</span>/downloads/secrets/pull-secret-bundle.json&quot;</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">RELEASE_NAME</span><span class="token operator">=</span><span class="token string">&quot;ocp-release&quot;</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">GODEBUG</span><span class="token operator">=</span><span class="token string">&quot;x509ignoreCN=0&quot;</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;export
 LOCAL_REGISTRY='&lt;registry_server_fqdn&gt;:5000'&quot;</span> <span class="token operator">&gt;&gt;</span>
 <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/env_ocp

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">'[[ ! <span class="token variable">${OCP_RELEASE}</span> =~ '</span>x86_64<span class="token string">' ]] &amp;&amp; export
 OCP_RELEASE=&quot;<span class="token variable">${OCP_RELEASE}</span>-x86_64&quot;'</span> <span class="token operator">&gt;&gt;</span>
 <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/env_ocp

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;export LOCAL_REPOSITORY='ocp/openshift4'&quot;</span> <span class="token operator">&gt;&gt;</span>
 <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/env_ocp

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">&quot;export PRODUCT_REPO='openshift-release-dev'&quot;</span> <span class="token operator">&gt;&gt;</span>
 <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/env_ocp

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">'export
 LOCAL_SECRET_JSON=&quot;<span class="token variable">${REGISTRY_BASE}</span>/downloads/secrets/pull-secret-bundle.json&quot;'</span>
 <span class="token operator">&gt;&gt;</span> <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/env_ocp

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token string">'export RELEASE_NAME=&quot;ocp-release&quot;'</span> <span class="token operator">&gt;&gt;</span>
 <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/env_ocp
</code></pre></div><p>Start the oc release mirroring process</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc adm -a <span class="token variable">${LOCAL_SECRET_JSON}</span> release mirror <span class="token punctuation">\</span>

 --from<span class="token operator">=</span>quay.io/<span class="token variable">${PRODUCT_REPO}</span>/<span class="token variable">${RELEASE_NAME}</span><span class="token builtin class-name">:</span><span class="token variable">${OCP_RELEASE}</span> <span class="token punctuation">\</span>

 --to<span class="token operator">=</span><span class="token variable">${LOCAL_REGISTRY}</span>/<span class="token variable">${LOCAL_REPOSITORY}</span> <span class="token punctuation">\</span>

 --to-release-image<span class="token operator">=</span><span class="token variable">${LOCAL_REGISTRY}</span>/<span class="token variable">${LOCAL_REPOSITORY}</span><span class="token builtin class-name">:</span><span class="token variable">${OCP_RELEASE}</span>
 <span class="token punctuation">\</span>

 <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token variable">${REGISTRY_BASE}</span>/downloads/secrets/mirror-output.txt
</code></pre></div><ol start="11"><li>Generating the openshift binary and validating the same</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">${REGISTRY_BASE}</span>/downloads/tools/

<span class="token operator">&gt;</span> oc adm -a <span class="token variable">${LOCAL_SECRET_JSON}</span> release extract
 --command<span class="token operator">=</span>openshift-install
 <span class="token string">&quot;<span class="token variable">${LOCAL_REGISTRY}</span>/<span class="token variable">${LOCAL_REPOSITORY}</span>:<span class="token variable">${OCP_RELEASE}</span>&quot;</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$?</span> -<span class="token operator">&gt;</span> this should <span class="token builtin class-name">return</span> a <span class="token number">0</span>
</code></pre></div><ol start="12"><li>Save the Registry container</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> podman stop my-registry
</code></pre></div><p>(optional)</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> podman <span class="token function">rm</span> --force my-registry

<span class="token operator">&gt;</span> podman save docker.io/library/registry:2 -o
 <span class="token variable">${REGISTRY_BASE}</span>/downloads/images/registry.tar
</code></pre></div><ol start="13"><li>Remove the unwanted certificates and generate the tar file of the
contents within registry directory. We will be creating a new
certificate for the internal mirror registry server</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">rm</span> -f <span class="token variable">${REGISTRY_BASE}</span>/certs/domain.*

<span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">${REGISTRY_BASE}</span>

<span class="token operator">&gt;</span> <span class="token function">tar</span> -zvcf ocp45-registry.tar.gz *
</code></pre></div><ol start="14"><li>This can be securely transferred to the server which is meant to be
used as a mirror-registry for installing OCP in the restricted
environment.</li></ol> <h3 id="for-the-installer-machine"><a href="#for-the-installer-machine" class="header-anchor">#</a> For the installer machine</h3> <ol><li>Create a new directory for storing the files related to installer
machine</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">mkdir</span> -p /opt/hpe/solutions/hpe-solutions-openshift/installer
</code></pre></div><ol start="2"><li>Navigate to the
/opt/hpe/solutions/hpe-solutions-openshift/registry/downloads/tools/
and copy the tools oc, kubectl and openshift-install into the folder
/opt/hpe/solutions/hpe-solutions-openshift/installer.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /opt/hpe/solutions/hpe-solutions-openshift/registry/downloads/tools/

<span class="token operator">&gt;</span> <span class="token function">cp</span> kubectl oc openshift-install
/opt/hpe/solutions/hpe-solutions-openshift/installer
</code></pre></div><ol start="3"><li>Create a install-config.yaml template file within
/opt/hpe/solutions/hpe-solutions-openshift/installer directory</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">cat</span> <span class="token operator">&gt;</span> /opt/hpe/solutions/hpe-solutions-openshift/installer/install-config.yaml <span class="token operator">&lt;&lt;</span> EOF
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1

 <span class="token key atrule">baseDomain</span><span class="token punctuation">:</span> <span class="token string">''</span>

 <span class="token key atrule">controlPlane</span><span class="token punctuation">:</span>

 <span class="token key atrule">name</span><span class="token punctuation">:</span> master

 <span class="token key atrule">hyperthreading</span><span class="token punctuation">:</span> Enabled

 <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>

 <span class="token key atrule">compute</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> worker

 <span class="token key atrule">hyperthreading</span><span class="token punctuation">:</span> Enabled

 <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>

 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>

 <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">''</span>

 <span class="token key atrule">networking</span><span class="token punctuation">:</span>

 <span class="token key atrule">clusterNetworks</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 10.128.0.0/14

 <span class="token key atrule">hostPrefix</span><span class="token punctuation">:</span> <span class="token number">23</span>

 <span class="token key atrule">machineNetwork</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 172.18.0.0/16

 <span class="token key atrule">networkType</span><span class="token punctuation">:</span> OpenShiftSDN

 <span class="token key atrule">serviceNetwork</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> 172.30.0.0/16

 <span class="token key atrule">platform</span><span class="token punctuation">:</span>

 <span class="token key atrule">none</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

 <span class="token key atrule">fips</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

 <span class="token key atrule">pullSecret</span><span class="token punctuation">:</span> <span class="token string">''</span>

 <span class="token key atrule">sshKey</span><span class="token punctuation">:</span> <span class="token string">''</span>

 <span class="token key atrule">additionalTrustBundle</span><span class="token punctuation">:</span> <span class="token punctuation">|</span>

 <span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>BEGIN CERTIFICATE<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>

 &lt;<span class="token punctuation">...</span>base<span class="token punctuation">-</span>64<span class="token punctuation">-</span>encoded<span class="token punctuation">,</span> DER <span class="token punctuation">-</span> CA certificate<span class="token punctuation">&gt;</span>

 <span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>END CERTIFICATE<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>

 EOF
</code></pre></div><ol start="4"><li>Tar the files corresponding to installer machine and securely
transfer them to the server which is meant to be used as an
installer for installing OCP in the restricted environment</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /opt/hpe/solutions/hpe-solutions-openshift/installer

<span class="token operator">&gt;</span> <span class="token function">tar</span> -zvcf installer.tar.gz *
</code></pre></div><h3 id="for-the-ipxe-server"><a href="#for-the-ipxe-server" class="header-anchor">#</a> For the iPXE server</h3> <ol><li>Create a directory as a destination and download the necessary RPMs
as follows</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">mkdir</span> -p /opt/hpe/solutions/hpe-solutions-openshift/coreos-images

<span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /opt/hpe/solutions/hpe-solutions-openshift/coreos-images

<span class="token operator">&gt;</span> <span class="token function">wget</span> https://www.rpmfind.net/linux/centos/7.8.2003/extras/x86_64/Packages/python-httplib2-0.9.2-1.el7.noarch.rpm

<span class="token operator">&gt;</span> <span class="token function">wget</span> https://www.rpmfind.net/linux/centos/7.8.2003/os/x86_64/Packages/python-jinja2-2.7.2-4.el7.noarch.rpm

<span class="token operator">&gt;</span> <span class="token function">wget</span> https://www.rpmfind.net/linux/epel/7/ppc64le/Packages/p/python-keyczar-0.71c-2.el7.noarch.rpm

<span class="token operator">&gt;</span> <span class="token function">wget</span> https://www.rpmfind.net/linux/centos/7.8.2003/extras/x86_64/Packages/sshpass-1.06-2.el7.x86_64.rpm

<span class="token operator">&gt;</span> <span class="token function">wget</span> https://www.rpmfind.net/linux/centos/7.8.2003/extras/x86_64/Packages/python-crypto-2.6.1-1.el7.centos.x86_64.rpm

<span class="token operator">&gt;</span> <span class="token function">wget</span> https://releases.ansible.com/ansible/rpm/release/epel-7-x86_64/ansible-2.9.9-1.el7.ans.noarch.rpm
</code></pre></div><ol start="2"><li>Retrieve the OCP ISO version</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token assign-left variable">OCP_ISO_VERSION</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> -s https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/sha256sum.txt<span class="token variable">)</span></span> <span class="token operator">|</span> <span class="token function">grep</span> live <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token punctuation">\</span>- <span class="token string">'{print <span class="token variable">$2</span>}'</span> <span class="token operator">|</span> <span class="token function">head</span> -1<span class="token punctuation">)</span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token variable">${OCP_ISO_VERSION}</span>
</code></pre></div><ol start="3"><li>Download the CoreOS images</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">wget</span> https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-<span class="token variable">${OCP_ISO_VERSION}</span>-x86_64-live-initramfs.x86_64.img

<span class="token operator">&gt;</span> <span class="token function">wget</span> https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-<span class="token variable">${OCP_ISO_VERSION}</span>-x86_64-live-kernel-x86_64

<span class="token operator">&gt;</span> <span class="token function">wget</span> https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/latest/latest/rhcos-<span class="token variable">${OCP_ISO_VERSION}</span>-x86_64-live-rootfs.x86_64.img
</code></pre></div><ol start="4"><li>Download git and git repositories - hpe-solutions-openshift and
matchbox with the following commands</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token function">git</span> -y
<span class="token operator">&gt;</span> <span class="token function">git</span> clone https://github.com/HewlettPackard/hpe-solutions-openshift.git
<span class="token operator">&gt;</span> <span class="token function">wget</span> https://github.com/poseidon/matchbox/releases/download/v0.8.0/matchbox-v0.8.0-linux-amd64.tar.gz
</code></pre></div><ol start="5"><li>Generate the Tar file of the images</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">tar</span> -zcf ipxe.tar.gz *
</code></pre></div><ol start="6"><li>This can be securely transferred to the server which is meant to be
used as the iPXE server for installing OCP in the restricted
environment.</li></ol> <p>Ansible and python setup -
<a href="https://medium.com/@theking99984/how-to-install-ansible-offline-on-centos-and-rhel-f3c872b2d91e" target="_blank" rel="noopener noreferrer">https://medium.com/@theking99984/how-to-install-ansible-offline-on-centos-and-rhel-f3c872b2d91e<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="centos-7-internal-yum-server"><a href="#centos-7-internal-yum-server" class="header-anchor">#</a> CentOS 7 internal Yum Server</h2> <ol><li>CentOS 7 Yum server is offline/disconnected server which has
conditional internet access and is used as a remote yum server for
the restricted network centos servers. It built on virtual machine
with the following configurations</li></ol> <p>a.  OS - CentOS 7 with preinstalled packages as follows</p> <div class="language- extra-class"><pre><code>- &quot;Development Tools&quot;

- &quot;Compatibility Libraries&quot;

- &quot;System Administration Tools&quot;
</code></pre></div><p>b.  CPU - 4 vCPU</p> <p>c.  Memory - 8 GB</p> <p>d.  Disk - 300 GB free space in the / partition</p> <p>e.  Network adapter - 1 network adapter with connectivity to the
production network</p> <ol start="2"><li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Solution-Deployment/Preparing-execution-environment.html#non-root-user-access">setup the non-root</a> section of
the deployment guide to create a non-root user and switch to the
thus created non-root user</p></li> <li><p>Navigate to the folder that contains the centos-rpms.tar.gz and
centos-yum -repository.tar.gz shared from the download server</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> path/to/copied/tar/file/centos-rpms.tar.gz
</code></pre></div><ol start="4"><li>Extract the tar file centos-rpms.tar.gz consisting of the RPMs
needed to bring up the offline/disconnected CentOS Yum server.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">tar</span> -xvf centos-rpms.tar.gz
</code></pre></div><ol start="5"><li>Install the RPMs</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">rpm</span> -ivh nginx-1.9.9-1.el7.ngx.x86_64.rpm

<span class="token operator">&gt;</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> <span class="token function">sudo</span> <span class="token function">rpm</span> -ivh deltarpm-3.6-3.el7.x86_64.rpm

<span class="token operator">&gt;</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> <span class="token function">sudo</span> <span class="token function">rpm</span> -ivh python-deltarpm-3.6-3.el7.x86_64.rpm

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">rpm</span> -ivh createrepo-0.9.9-28.el7.noarch.rpm
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Try with --nodeps option if its failing</p></div> <ol start="6"><li>Enable, start and verify the status of Nginx web service.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> systemctl start nginx

<span class="token operator">&gt;</span> <span class="token function">sudo</span> systemctl status nginx
</code></pre></div><ol start="7"><li>Move and untar the <em>centos-yum-repository.tar.gz</em> to the root
directory of the Nginx server i.e, /usr/share/nginx/html/</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">tar</span> -xvf path/to/copied/tar/file/centos-yum-repository.tar.gz -C
/usr/share/nginx/html/
</code></pre></div><ol start="8"><li>Create the Yum repos for base, extras, updates and centosplus repos.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> createrepo /usr/share/nginx/html/base/

<span class="token operator">&gt;</span> <span class="token function">sudo</span> createrepo /usr/share/nginx/html/centosplus/

<span class="token operator">&gt;</span> <span class="token function">sudo</span> createrepo /usr/share/nginx/html/extras/

<span class="token operator">&gt;</span> <span class="token function">sudo</span> createrepo /usr/share/nginx/html/updates/
</code></pre></div><ol start="9"><li>Update the Nginx configuration file with the following details to
host the Yum repository.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">vi</span> /etc/nginx/conf.d/repos.conf
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code> server {

 listen 80;

 server_name **&lt;IP_address_or_FQDN_of_the_centos_yum_server&gt;;**

 root /usr/share/nginx/html/;

 location / {

 index index.php index.html index.htm;

 autoindex on; #enable listing of directory index

 }

 }
</code></pre></div><ol start="10"><li><p>Remove/rename files with extention .html in /usr/share/nginx/html/</p></li> <li><p>Restart the nginx web service</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> systemctl restart nginx
</code></pre></div><ol start="12"><li>Update the firewall ports to allow http communication.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">FIREWALLD_DEFAULT_ZONE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>firewall-cmd --get-default-zone<span class="token variable">`</span></span>

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">80</span>/tcp --zone<span class="token operator">=</span><span class="token variable">$FIREWALLD_DEFAULT_ZONE</span>
--permanent

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --reload
</code></pre></div><ol start="13"><li>Validate the creation of yum server with the following command. You
should be able to the see the following content</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">curl</span> http://<span class="token operator">&lt;</span>IP_address_or_FQDN_of_the_centos_yum_server<span class="token operator">&gt;</span>/
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Index of /<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span> <span class="token attr-name">bgcolor</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>white<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Index of /<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pre</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>../<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>base/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>base/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>centosplus/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>centosplus/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>extras/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>extras/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>updates/<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>updates/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>50x.html.bck<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>50x.html.bck<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>index.html.bck<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>index.html.bck<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pre</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>hr</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Reference</p> <p><a href="https://www.tecmint.com/setup-local-http-yum-repository-on-centos-7/" target="_blank" rel="noopener noreferrer">https://www.tecmint.com/setup-local-http-yum-repository-on-centos-7/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="mirror-registry-internal-registry"><a href="#mirror-registry-internal-registry" class="header-anchor">#</a> Mirror registry (Internal registry)</h2> <p>Mirror registry is the server which serves as the container registry for
the Red Hat OpenShift Container Platform cluster, this server does not
have internet access and is built on virtual machine with the following
configurations</p> <p>a.  OS - CentOS 7 with preinstalled packages as follows</p> <div class="language- extra-class"><pre><code>- &quot;Development Tools&quot;

- &quot;Compatibility Libraries&quot;

- &quot;System Administration Tools&quot;
</code></pre></div><p>b.  CPU - 4 vCPU</p> <p>c.  Memory - 8 GB</p> <p>d.  Disk - 300 GB free space in the / partition</p> <p>e.  Network adapter - 1 network adapter with connectivity to the
production network</p> <ol><li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Solution-Deployment/Preparing-execution-environment.html#non-root-user-access">setup the non-root</a>section of
the deployment guide to create a non-root user and switch to the
thus created non-root user</p></li> <li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#setup-centos-servers-to-use-internal-yum-server">Setup centos servers to use internal yum
server</a> section of the deployment
guide to enable offline package/module installation for the mirror
registry</p></li> <li><p>Set the hostname of the internal registry server and update the same
in /etc/hosts file as follows:</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> hostnamectl set-hostname registry

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">vi</span> /etc/hosts

 <span class="token number">127.0</span>.0.1 <span class="token operator">&lt;</span>registry_hostname<span class="token operator">&gt;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Registry_hostname refers to common hostname/FQDN of the download servers
and the internal mirror registry.</p> <p>It is not necessary to create the DNS entry of the download server.</p></div> <ol start="4"><li>Create a directory for the mirror-registry files</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">mkdir</span> -p /opt/hpe/solutions/hpe-solutions-openshift/registry
</code></pre></div><ol start="5"><li>Move and extract the ocp45-registry.tar.gz file from the
download/external server to the location
/opt/hpe/solutions/hpe-solutions-openshift/registry</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">REGISTRY_BASE</span><span class="token operator">=</span>/opt/hpe/solutions/hpe-solutions-openshift/registry

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">tar</span> -xvf /path/to/ocp45-registry.tar.gz -C <span class="token variable">$REGISTRY_BASE</span>
</code></pre></div><ol start="6"><li>Source the environment variables as saved in env_ocp file from the
download/external server</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">source</span> <span class="token variable">$REGISTRY_BASE</span>/downloads/tools/env_ocp
</code></pre></div><ol start="7"><li>Create the certificate for the internal registry server</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">$REGISTRY_BASE</span>/certs/

<span class="token operator">&gt;</span> <span class="token function">sudo</span> openssl req -newkey rsa:4096 -nodes -sha256 -keyout domain.key
 -x509 -days <span class="token number">365</span> -out domain.crt
</code></pre></div><p>Provide the following details when prompted</p> <div class="language- extra-class"><pre class="language-text"><code> Country Name (2 letter code) [AU] : US

 State or Province Name (full name) : New York

 Locality Name (eg, city) [] : New York

 Organization Name (eg, company) : MyOrg

 Organizational Unit Name (eg, section) [] : MyOU

 Common Name (e.g. server FQDN or YOUR name) [] :
 &lt;registry_server_fqdn -&gt; same as external download server fqdn&gt;

 Email Address [] : &lt;email_address&gt;
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Provide the same email ID for the flag &lt;email_address&gt; as provided in
the external download server while downloading the openshift images.</p></div> <ol start="8"><li>Trust the self-signed certificate generated earlier</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">cp</span> <span class="token variable">$REGISTRY_BASE</span>/certs/domain.crt
/etc/pki/ca-trust/source/anchors/

<span class="token operator">&gt;</span> <span class="token function">sudo</span> update-ca-trust extract
</code></pre></div><ol start="9"><li>Install podman</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> yum <span class="token function">install</span> podman -y
</code></pre></div><ol start="10"><li>Load the registry container image and verify the same using the
following command</li></ol> <div class="language- extra-class"><pre class="language-text"><code>&gt; sudo podman load -i $REGISTRY_BASE/downloads/images/registry.tar

&gt; sudo podman image list
</code></pre></div><ol start="11"><li>Update the Firewall rules to open the ports 5000 using the following
commands</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">FIREWALLD_DEFAULT_ZONE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>firewall-cmd --get-default-zone<span class="token variable">`</span></span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$FIREWALLD_DEFAULT_ZONE</span>

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">5000</span>/tcp --zone<span class="token operator">=</span>$
 FIREWALLD_DEFAULT_ZONE --permanent

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --reload
</code></pre></div><ol start="12"><li>Run the podman registry container and verify the same using the
following commands</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> podman run --name my-registry --rm -d -p <span class="token number">5000</span>:5000 <span class="token punctuation">\</span>

 -v <span class="token variable">$REGISTRY_BASE</span>/data:/var/lib/registry:z <span class="token punctuation">\</span>

 -v <span class="token variable">$REGISTRY_BASE</span>/auth:/auth:z <span class="token punctuation">\</span>

 -e <span class="token string">&quot;REGISTRY_AUTH=htpasswd&quot;</span> <span class="token punctuation">\</span>

 -e <span class="token string">&quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry&quot;</span> <span class="token punctuation">\</span>

 -e <span class="token string">&quot;REGISTRY_HTTP_SECRET=ALongRandomSecretForRegistry&quot;</span> <span class="token punctuation">\</span>

 -e <span class="token assign-left variable">REGISTRY_AUTH_HTPASSWD_PATH</span><span class="token operator">=</span>/auth/htpasswd <span class="token punctuation">\</span>

 -v <span class="token variable">$REGISTRY_BASE</span>/certs:/certs:z <span class="token punctuation">\</span>

 -e <span class="token assign-left variable">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="token operator">=</span>/certs/domain.crt <span class="token punctuation">\</span>

 -e <span class="token assign-left variable">REGISTRY_HTTP_TLS_KEY</span><span class="token operator">=</span>/certs/domain.key
 docker.io/library/registry:2

<span class="token operator">&gt;</span> <span class="token function">sudo</span> podman <span class="token function">ps</span>

<span class="token operator">&gt;</span> <span class="token function">curl</span> -u myuser:mypassword -k https://<span class="token operator">&lt;</span>registry_hostname_fqdn<span class="token operator">&gt;</span>:5000/v2/_catalog
</code></pre></div><p>Replace the <strong>&lt;registry_hostname_fqdn&gt;</strong> to the fully qualified domain
name of the internal mirror registry server. Output of the above command
should be as follows:</p> <div class="language- extra-class"><pre class="language-text"><code>{&quot;repositories&quot;:[ocp/openshift4]}
</code></pre></div><h2 id="dns-entries"><a href="#dns-entries" class="header-anchor">#</a> DNS entries</h2> <p>Consult the <a href="/hpe-solutions-openshift/46-synergy/Solution-Deployment/User-provisioned-DNS-requirements.html#user-provisioned-dns-requirements">User Provisioned DNS requirements</a> section for details on
creating the DNS entries required for the Red Hat OpenShift Container
Platform installation.</p> <h2 id="load-balance-server-with-haproxy"><a href="#load-balance-server-with-haproxy" class="header-anchor">#</a> Load balance server with HAProxy</h2> <p>This server is used as a load balancer for the Red Hat OpenShift
Container Platform cluster, this server does not have internet access
and is built on virtual machine with the following configurations</p> <p>a.  OS - CentOS 7 with preinstalled packages as follows</p> <div class="language- extra-class"><pre><code>- &quot;Development Tools&quot;

- &quot;Compatibility Libraries&quot;

- &quot;System Administration Tools&quot;
</code></pre></div><p>b.  CPU - 4 vCPU</p> <p>c.  Memory - 8 GB</p> <p>d.  Disk - 150 GB</p> <p>e.  Network adapter - 1 network adapter with connectivity to the
production network</p> <ol><li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Solution-Deployment/Preparing-execution-environment.html#non-root-user-access">setup the non-root</a> section of
the deployment guide to create a non-root user and switch to the
thus created non-root user</p></li> <li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#setup-centos-servers-to-use-internal-yum-server">Setup centos servers to use internal yum
server</a>  section of the deployment
guide to enable offline package/module installation for the mirror
registry</p></li> <li><p>Disable SELinux</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">sed</span> -i <span class="token string">'s/enforcing/disabled/g'</span> /etc/selinux/config
</code></pre></div><ol start="4"><li>Set the hostname of the loadbalancer server as follows:</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> hostnamectl set-hostname <span class="token operator">&lt;</span>loadbalancer_fqdn<span class="token operator">&gt;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>A reboot may be required at this point to reflect the changes done so
far.</p></div> <p>To check selinux status, use the following command.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> getenforce
</code></pre></div><ol start="5"><li>Install HAProxy using the following command</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> yum -y <span class="token function">install</span> haproxy
</code></pre></div><ol start="6"><li>Update the HAProxy configuration file present at
/etc/haproxy/haproxy.cfg as follows</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">vi</span> /etc/haproxy/haproxy.cfg
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token comment">#---------------------------------------------------------------------</span>

 <span class="token comment"># Example configuration for a possible web application. See the</span>

 <span class="token comment"># full configuration options online.</span>

 <span class="token comment">#</span>

 <span class="token comment"># &lt;http://haproxy.1wt.eu/download/1.4/doc/configuration.txt&gt;</span>

 <span class="token comment">#</span>

 <span class="token comment">#---------------------------------------------------------------------</span>

 <span class="token comment">#---------------------------------------------------------------------</span>

 <span class="token comment"># Global settings</span>

 <span class="token comment">#---------------------------------------------------------------------</span>

 global

 <span class="token comment"># to have these messages end up in /var/log/haproxy.log you will</span>

 <span class="token comment"># need to:</span>

 <span class="token comment">#</span>

 <span class="token comment"># 1) configure syslog to accept network log events. This is done</span>

 <span class="token comment"># by adding the '-r' option to the SYSLOGD_OPTIONS in</span>

 <span class="token comment"># /etc/sysconfig/syslog</span>

 <span class="token comment">#</span>

 <span class="token comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span>

 <span class="token comment"># file. A line like the following can be added to</span>

 <span class="token comment"># /etc/sysconfig/syslog</span>

 <span class="token comment">#</span>

 <span class="token comment"># local2.* /var/log/haproxy.log</span>

 <span class="token comment">#</span>

 log 127.0.0.1 local2

 chroot /var/lib/haproxy

 pidfile /var/run/haproxy.pid

 maxconn 4000

 user haproxy

 group haproxy

 daemon

 <span class="token comment"># turn on stats unix socket</span>

 stats socket /var/lib/haproxy/stats

 <span class="token comment">#---------------------------------------------------------------------</span>

 <span class="token comment"># common defaults that all the 'listen' and 'backend' sections</span>
 will

 <span class="token comment"># use if not designated in their block</span>

 <span class="token comment">#---------------------------------------------------------------------</span>

 defaults

 mode http

 log global

 option httplog

 option dontlognull

 option http<span class="token punctuation">-</span>server<span class="token punctuation">-</span>close

 option forwardfor except 127.0.0.0/8

 option redispatch

 retries 3

 timeout http<span class="token punctuation">-</span>request 10s

 timeout queue 1m

 timeout connect 10s

 timeout client 1m

 timeout server 1m

 timeout http<span class="token punctuation">-</span>keep<span class="token punctuation">-</span>alive 10s

 timeout check 10s

 maxconn 3000

 <span class="token comment">#---------------------------------------------------------------------</span>

 <span class="token comment"># main frontend which proxys to the backends</span>

 <span class="token comment">#---------------------------------------------------------------------</span>

 frontend main <span class="token important">*:</span><span class="token number">5000</span>

 acl url_static path_beg <span class="token punctuation">-</span>i /static /images /javascript /stylesheets

 acl url_static path_end <span class="token punctuation">-</span>i .jpg .gif .png .css .js

 use_backend static if url_static

 default_backend app

 <span class="token comment">#---------------------------------------------------------------------</span>

 <span class="token comment"># static backend for serving up images, stylesheets and such</span>

 <span class="token comment">#---------------------------------------------------------------------</span>

 backend static

 balance roundrobin

 server static 127.0.0.1<span class="token punctuation">:</span>4331 check

 <span class="token comment">#---------------------------------------------------------------------</span>

 <span class="token comment"># round robin balancing between the various backends</span>

 <span class="token comment">#---------------------------------------------------------------------</span>

 backend app

 balance roundrobin

 server app1 127.0.0.1<span class="token punctuation">:</span>5001 check

 server app2 127.0.0.1<span class="token punctuation">:</span>5002 check

 server app3 127.0.0.1<span class="token punctuation">:</span>5003 check

 server app4 127.0.0.1<span class="token punctuation">:</span>5004 check

 frontend openshift<span class="token punctuation">-</span>api<span class="token punctuation">-</span>server

 bind <span class="token important">*:</span><span class="token number">6443</span>

 default_backend openshift<span class="token punctuation">-</span>api<span class="token punctuation">-</span>server

 mode tcp

 option tcplog

 backend openshift<span class="token punctuation">-</span>api<span class="token punctuation">-</span>server

 balance source

 mode tcp

 server ocpboot ocpboot.ocp.twentynet.local<span class="token punctuation">:</span>6443 check

 server ocpmaster1 ocpmaster1.ocp.twentynet.local<span class="token punctuation">:</span>6443 check

 server ocpmaster2 ocpmaster2.ocp.twentynet.local<span class="token punctuation">:</span>6443 check

 server ocpmaster3 ocpmaster3.ocp.twentynet.local<span class="token punctuation">:</span>6443 check

 frontend machine<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server68

 bind <span class="token important">*:</span><span class="token number">22623</span>

 default_backend machine<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server

 mode tcp

 option tcplog

 backend machine<span class="token punctuation">-</span>config<span class="token punctuation">-</span>server

 balance source

 mode tcp

 server ocpboot ocpboot.ocp.twentynet.local<span class="token punctuation">:</span>22623 check

 server ocpmaster1 ocpmaster1.ocp.twentynet.local<span class="token punctuation">:</span>22623 check

 server ocpmaster2 ocpmaster2.ocp.twentynet.local<span class="token punctuation">:</span>22623 check

 server ocpmaster3 ocpmaster3.ocp.twentynet.local<span class="token punctuation">:</span>22623 check

 frontend ingress<span class="token punctuation">-</span>http

 bind <span class="token important">*:</span><span class="token number">80</span>

 default_backend ingress<span class="token punctuation">-</span>http

 mode tcp

 option tcplog

 backend ingress<span class="token punctuation">-</span>http

 balance source

 mode tcp

 server ocpworker1 ocpworker1.ocp.twentynet.local<span class="token punctuation">:</span>80 check

 server ocpworker2 ocpworker2.ocp.twentynet.local<span class="token punctuation">:</span>80 check

 server ocpworker3 ocpworker3.ocp.twentynet.local<span class="token punctuation">:</span>80 check

 frontend ingress<span class="token punctuation">-</span>https

 bind <span class="token important">*:</span><span class="token number">443</span>

 default_backend ingress<span class="token punctuation">-</span>https

 mode tcp

 option tcplog

 backend ingress<span class="token punctuation">-</span>https

 balance source

 mode tcp

 server ocpworker1 ocpworker1.ocp.twentynet.local<span class="token punctuation">:</span>443 check

 server ocpworker2 ocpworker2.ocp.twentynet.local<span class="token punctuation">:</span>443 check

 server ocpworker3 ocpworker3.ocp.twentynet.local<span class="token punctuation">:</span>443 check
</code></pre></div><ol start="7"><li>Start the haproxy service</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> systemctl start haproxy
</code></pre></div><ol start="8"><li>Update the Firewall rules to open the ports 80, 443, 6443, 22623
using the following commands</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">FIREWALLD_DEFAULT_ZONE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>firewall-cmd --get-default-zone<span class="token variable">`</span></span>

<span class="token operator">&gt;</span> <span class="token builtin class-name">echo</span> <span class="token variable">$FIREWALLD_DEFAULT_ZONE</span>

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">80</span>/tcp
--zone<span class="token operator">=</span><span class="token variable">$FIREWALLD_DEFAULT_ZONE</span> --permanent

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">443</span>/tcp
--zone<span class="token operator">=</span><span class="token variable">$FIREWALLD_DEFAULT_ZONE</span> --permanent

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">6443</span>/tcp
--zone<span class="token operator">=</span><span class="token variable">$FIREWALLD_DEFAULT_ZONE</span> --permanent

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --add-port<span class="token operator">=</span><span class="token number">22623</span>/tcp
--zone<span class="token operator">=</span><span class="token variable">$FIREWALLD_DEFAULT_ZONE</span> --permanent

<span class="token operator">&gt;</span> <span class="token function">sudo</span> firewall-cmd --reload
</code></pre></div><p>The load balance node is now ready to be used.</p> <h2 id="installer-machine"><a href="#installer-machine" class="header-anchor">#</a> Installer machine</h2> <p>This machine acts as the installer machine for deploying CoreOS for the
Red Hat OpenShift Container Platform cluster nodes, this server does not
have internet access and is built on virtual machine with the following
configurations</p> <ul><li><p>OS - CentOS 7 with preinstalled packages as follows</p> <div class="language- extra-class"><pre><code>  - &quot;Development Tools&quot;

  - &quot;Compatibility Libraries&quot;

  - &quot;System Administration Tools&quot;
</code></pre></div></li> <li><p>CPU - 4 vCPU</p></li> <li><p>Memory - 8 GB</p></li> <li><p>Disk - 150 GB free space in the / partition</p></li> <li><p>Network adapter - 1 network adapter with connectivity to the
production network</p></li></ul> <ol><li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Solution-Deployment/Preparing-execution-environment.html#non-root-user-access">setup the non-root</a> section of
the deployment guide to create a non-root user and switch to the
thus created non-root user.</p></li> <li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#setup-centos-servers-to-use-internal-yum-server">Setup centos servers to use internal yum
server</a>  section of the deployment
guide to enable offline package/module installation for the mirror
registry.</p></li> <li><p>Navigate to the path to the installer.tar.gz file from the download
server and untar it.</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /path/to/installer.tar.gz

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">tar</span> -xvf installer.tar.gz
</code></pre></div><ol start="4"><li>Create a softlink for the openshift-install and oc tools</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">ln</span> -s /absolute/path/to/oc /usr/local/bin/oc

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">ln</span> -s /absolute/path/to/openshift-install
/usr/local/bin/openshift-install

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">ln</span> -s /abslute/path/to/kubectl /usr/local/bin/kubectl
</code></pre></div><ol start="5"><li>Update the install-config.yaml file with the following details.</li></ol> <ul><li><p><strong>baseDomain</strong>: Base domain of the DNS which hosts Red Hat
OpenShift Container Platform.</p></li> <li><p><strong>name</strong>: Name of the OpenShift cluster. This is same as the new
domain created in DNS.</p></li> <li><p><strong>replicas</strong>: Update this field to reflect the corresponding
number of master or worker instances required for the OpenShift
cluster as per the installation environment requirements. It is
recommended to have a minimum of 3 master nodes and 2 worker
nodes per OpenShift cluster.</p></li> <li><p><strong>pullSecret</strong>: This should now be the contents of the
pull_secret_registry.json present in the &quot;mirror registry
server&quot;(internal) at
/opt/hpe/solutions/hpe-solutions-openshift/registry/downloads/secrets/
pull_secret_registry.json. It consists of the credentials to
access the internal/mirror registry only created for the
restricted network installation of the Red Hat OpenShift
Container Platform cluster.</p></li> <li><p><strong>sshKey</strong>: Update this field with the ssh-key generated for the
non-root user of the installer machine. Sshkey can be generated
with the following command.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> ssh-keygen
</code></pre></div><p>The resultant value can be retrieved from the /home/non-root-user/.ssh/id_rsa.pub</p> <div class="language-tip NOTE extra-class"><pre class="language-text"><code>Replace 'non-root-user' in the above path with the username given for the non-root-user
</code></pre></div></li> <li><p><strong>additionalTrustBundle</strong>: Update this field with the CA
certificated (domain.crt) generated in the internal/mirror registry.
It can be found at
/opt/hpe/solutions/hpe-solutions-openshift/registry/certs/domain.crt
within the internal mirror registry server. Make sure the value to
this field is right indented (5 spaces from the left).</p></li> <li><p><strong>imageContentSources</strong>: This content is taken from the
mirror-output.txt generated in the &quot;Download server &gt; For the
mirror registry&quot; section of this document. It consists of the end
points to connect to, to download the required files while created
the Red Hat OpenShift Container Platform cluster in a restricted
network environment.</p></li></ul> <p>The final version should look as follows:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1

 <span class="token key atrule">baseDomain</span><span class="token punctuation">:</span> &lt;your base domain. Similar to example.com<span class="token punctuation">&gt;</span>

 <span class="token key atrule">controlPlane</span><span class="token punctuation">:</span>

 <span class="token key atrule">name</span><span class="token punctuation">:</span> master

 <span class="token key atrule">hyperthreading</span><span class="token punctuation">:</span> Enabled

 <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>

 <span class="token key atrule">compute</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> worker

 <span class="token key atrule">hyperthreading</span><span class="token punctuation">:</span> Enabled

 <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>

 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>

 <span class="token key atrule">name</span><span class="token punctuation">:</span> '&lt;your subdomain or cluster name. similar to test<span class="token punctuation">-</span>cluster<span class="token punctuation">&gt;</span>

 <span class="token key atrule">networking</span><span class="token punctuation">:</span>

 <span class="token key atrule">clusterNetworks</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 10.128.0.0/14

 <span class="token key atrule">hostPrefix</span><span class="token punctuation">:</span> <span class="token number">23</span>

 <span class="token key atrule">machineNetwork</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">cidr</span><span class="token punctuation">:</span> 172.18.0.0/16

 <span class="token key atrule">networkType</span><span class="token punctuation">:</span> OpenShiftSDN

 <span class="token key atrule">serviceNetwork</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> 172.30.0.0/16

 <span class="token key atrule">platform</span><span class="token punctuation">:</span>

 <span class="token key atrule">none</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

 <span class="token key atrule">fips</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

 <span class="token key atrule">pullSecret**</span><span class="token punctuation">:</span> '&lt;contents of the pull_secret_registry.json file
 similar to <span class="token punctuation">-</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>&quot;auths&quot;<span class="token punctuation">:</span><span class="token punctuation">{</span>&quot;&lt;registry_hostname_fqdn<span class="token punctuation">&gt;</span><span class="token punctuation">:</span>5000&quot;<span class="token punctuation">:</span><span class="token punctuation">{</span>&quot;auth&quot;<span class="token punctuation">:</span><span class="token string">&quot;bXl1c2VyOm15cGFzc3dvcmQ=&quot;</span><span class="token punctuation">,</span>&quot;email&quot;<span class="token punctuation">:</span><span class="token string">&quot;&lt;email_address&gt;&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">&gt;</span>'

 <span class="token key atrule">sshKey**</span><span class="token punctuation">:</span> <span class="token string">'&lt; Your installer machine Public SSH Key&gt;'</span>

 <span class="token key atrule">additionalTrustBundle</span><span class="token punctuation">:</span> <span class="token punctuation">|</span>

      <span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>BEGIN CERTIFICATE<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>
      &lt;Your CA certificate generated by the non<span class="token punctuation">-</span>root user in the internal mirror registry<span class="token punctuation">&gt;</span>

      <span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>END CERTIFICATE<span class="token punctuation">---</span><span class="token punctuation">-</span><span class="token punctuation">-</span>

 <span class="token key atrule">imageContentSources</span><span class="token punctuation">:</span>

 <span class="token punctuation">-</span> <span class="token key atrule">mirrors</span><span class="token punctuation">:</span>

   <span class="token punctuation">-</span> &lt; registry_hostname_fqdn <span class="token punctuation">&gt;</span><span class="token punctuation">:</span>5000/ocp/openshift4

   <span class="token key atrule">source</span><span class="token punctuation">:</span> quay.io/openshift<span class="token punctuation">-</span>release<span class="token punctuation">-</span>dev/ocp<span class="token punctuation">-</span>release

 <span class="token punctuation">-</span> <span class="token key atrule">mirrors</span><span class="token punctuation">:</span>

   <span class="token punctuation">-</span> &lt; registry_hostname_fqdn <span class="token punctuation">&gt;</span><span class="token punctuation">:</span>5000/ocp/openshift4

   <span class="token key atrule">source</span><span class="token punctuation">:</span> quay.io/openshift<span class="token punctuation">-</span>release<span class="token punctuation">-</span>dev/ocp<span class="token punctuation">-</span>v4.0<span class="token punctuation">-</span>art<span class="token punctuation">-</span>dev
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">NOTE</p> <p>It is recommended to take a backup of the
install-config.yaml file before creating the manifests/ignition file
since the file will be consumed while they are created.</p></div> <ol start="6"><li>Navigate to the path where install-config.yaml is present, create a
new directory for the ignition files and copy the
install-config.yaml into it. Navigate into the newly created folder</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">mkdir</span> <span class="token operator">&lt;</span>/path/to/directory/with/openshift-install/tools<span class="token operator">&gt;</span>/ignitions

<span class="token operator">&gt;</span> <span class="token function">cp</span> install-config.yaml ignitions/

<span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /path/to/ignitions/directory
</code></pre></div><ol start="7"><li>Create the manifests using the following command</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> openshift-install create manifests --dir<span class="token operator">=</span>./
</code></pre></div><ol start="8"><li>Create the ignition files</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> openshift-install create ignition-configs --dir<span class="token operator">=</span>./
</code></pre></div><p>The ignition files thus generated could be used while the CoreOS
operating system is booted on the bootstrap, master and worker nodes
via the iPXE server.</p> <ol start="9"><li>Export the kubeconfig file with the following command</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/path/to/kubeconfig/file
</code></pre></div><h2 id="openshift-cluster-nodes"><a href="#openshift-cluster-nodes" class="header-anchor">#</a> Openshift cluster nodes</h2> <p>Red Hat OpenShift Container Platform sizing varies depending on the
requirements of the organization and type of deployment. This section
highlights the host sizing details recommended by Red Hat.</p> <table><thead><tr><th>Resource</th> <th>Bootstrap node</th> <th>Master node</th> <th>Worker node</th></tr></thead> <tbody><tr><td>CPU</td> <td>4</td> <td>4</td> <td>4</td></tr> <tr><td>Memory</td> <td>16GB</td> <td>16GB</td> <td>16GB</td></tr> <tr><td>Disk storage</td> <td>120GB</td> <td>120GB</td> <td>120GB</td></tr></tbody></table> <p>Disk partitions on each of the nodes are as follows.</p> <ul><li><p>/var -- 40GB</p></li> <li><p>/usr/local/bin -- 1GB</p></li> <li><p>Temporary directory -- 1GB</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Sizing for worker nodes is ultimately dependent on the container
workloads and their CPU, memory, and disk requirements.</p></div> <p>For more information about Red Hat OpenShift Container Platform sizing,
refer to the Red Hat OpenShift Container Platform 4 product
documentation at
<a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/4.6/html/scalability_and_performance/index" target="_blank" rel="noopener noreferrer">https://access.redhat.com/documentation/en-us/openshift_container_platform/4.6/html/scalability_and_performance/index<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="ipxe-server"><a href="#ipxe-server" class="header-anchor">#</a> iPXE server</h2> <p>This server is used as OS deployment server for deploying CoreOS for the
Red Hat OpenShift Container Platform cluster nodes, this server does not
have internet access and is built on virtual machine with the following
configurations</p> <ul><li><p>OS - CentOS 7 with preinstalled packages as follows</p> <ul><li><p>&quot;Development Tools&quot;</p></li> <li><p>&quot;Compatibility Libraries&quot;</p></li> <li><p>&quot;System Administration Tools&quot;</p></li></ul></li> <li><p>CPU - 4 vCPU</p></li> <li><p>Memory - 8 GB</p></li> <li><p>Disk - 300 GB free space in the / partition</p></li> <li><p>Network adapter - 1 network adapter with connectivity to the
production network</p></li></ul> <ol><li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Solution-Deployment/Preparing-execution-environment.html#non-root-user-access">setup the non-root</a> section of
the deployment guide to create a non-root user and switch to the
thus created non-root user</p></li> <li><p>Refer to the <a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/Air-gap-Installation.html#setup-centos-servers-to-use-internal-yum-server">Setup centos servers to use internal yum
server</a>  section of the deployment
guide to enable offline package/module installation for the mirror
registry</p></li> <li><p>Navigate to the path to the ipxe.tar.gz file from the download
server and untar it.</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> path/to/ipxe.tar.gz

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">tar</span> -xvf ipxe.tar.gz
</code></pre></div><ol start="4"><li>Install all the necessary RPMs and ansible as follows.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> yum localinstall -y *.rpm
</code></pre></div><ol start="5"><li>Navigate to the directory &quot;deploy-coreos&quot; path of the github
repository hpe-solutions-openshift.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /path/to/hpe-solutions-openshift/

<span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> synergy/scalable/os-deployment/deploy-rhcos
</code></pre></div><p>It is recommended to store the github repository at /opt/hpe/solutions/.</p> <ol start="6"><li>Update the input files such hosts with the following command:</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">vi</span> hosts
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>add the parameters (ansible_ssh_pass, ansible_ssh_user) in the
host file for the non-root user</p> <p>Eg. 10.4.1.141 ansible_ssh_pass=xxx ansible_ssh_user=user</p></div> <ol start="7"><li>Update the encrypted input file secret.yml with the following
command</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> ansible-vault edit secret.yml
</code></pre></div><p>The default password for the encrypted file is &quot;changeme&quot;</p> <ol start="8"><li>Generate the SSH key for the openshift_admin user and copy the SSH
key to the known hosts file using the following command.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ssh-keygen
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Ensure there are no previous self-entries in the known host file.</p></div> <ol start="9"><li>Copy the thus generated SSH key to the known hosts file using the
following command</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> ssh-copy-id openshift_admin@<span class="token operator">&lt;</span>ipxe_fqdn<span class="token operator">&gt;</span>
</code></pre></div><ol start="10"><li>Move the downloaded matchbox tar file <a href="https://github.com/poseidon/matchbox/releases/download/v0.8.0/matchbox-v0.8.0-linux-amd64.tar.gz" target="_blank" rel="noopener noreferrer">matchbox-v0.8.0-linux-amd64.tar.gz<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to /tmp/ directory and provide the read permission using the following command</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">mv</span> /path/to/matchbox-v0.8.0-linux-amd64.tar.gz<span class="token punctuation">)</span> /tmp/

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">400</span> /tmp<span class="token punctuation">[</span>matchbox-v0.8.0-linux-amd64.tar.gz
</code></pre></div><ol start="11"><li>Execute the following to setup iPXE</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> ansible-playbook -i hosts master.yml --ask-vault-pass
</code></pre></div><ol start="12"><li>Copy the ignitions files from the installer machine to
/var/lib/matchbox/igniton/ folders and provide all permissions to
the ignition files</li></ol> <p>Only this command to be executed on the installer machine</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">scp</span> /path/to/ignitions/files
openshift_admin@<span class="token operator">&lt;</span>installer_server_fqdn_or_ip_address<span class="token operator">&gt;</span>:/home/openshift_admin
</code></pre></div><p>On the iPXE server</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">cp</span> /home/openshift_admin/*.ign /var/lib/matchbox/ignition
<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">chmod</span> <span class="token number">777</span> /var/lib/matchbox/ignition/*.ign
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Ensure the services xinetd, matchbox, tftp, dnsmasq are in
active/running state in the iPXE server before initiating the
installation of the CoreOS.</p></div> <ol start="13"><li>Boot the cluster nodes to complete the installation of Red Hat
CoreOS.</li></ol> <p>For further details on setting up the iPXE server, refer to the <a href="/hpe-solutions-openshift/46-synergy/Solution-Deployment/Operating-system-deployment.html#operating-system-deployment">OS
deployment</a></p> <div class="custom-block tip"><p class="custom-block-title">REGISTRY TESTING</p> <p>This is a very important point, make sure you are able to access your
registry from the bootstrap server.</p> <p>$ curl -u myuser:mypassword -k https://&lt;registry_fqdn_or_ip_address&gt;:5000/v2/_catalog</p></div> <h2 id="red-hat-openshift-container-platform-cluster-installation"><a href="#red-hat-openshift-container-platform-cluster-installation" class="header-anchor">#</a> Red Hat OpenShift Container Platform Cluster Installation</h2> <ol><li>Login to the installer machine and start the bootstrap installation
with the following command</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> /path/to/ignition/files

<span class="token operator">&gt;</span> openshift-install --dir<span class="token operator">=</span>./ wait-for bootstrap-complete --log-level
debug
</code></pre></div><p>Output is similar to as follows:</p> <div class="language- extra-class"><pre class="language-text"><code> INFO Waiting up to 30m0s for the Kubernetes API at
 &lt;https://api.ocp4.example.com:6443&gt;...

 INFO API v1.13.4+b626c2fe1 up

 INFO Waiting up to 30m0s for the bootstrap-complete event...
</code></pre></div><p>You can monitor the progress of the installation in the bootstrap
server. This also helps in tracking the errors, they are self
explainatory and helps understand what is happening.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">ssh</span> core@bootstrap <span class="token string">&quot;journalctl -xe&quot;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>After bootstrap process is complete, you can safely remove the bootstrap
machine from the load balancer.</p></div> <ol start="2"><li>Logging into the cluster</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span>/path/to/kubeconfig/file

<span class="token operator">&gt;</span> oc <span class="token function">whoami</span>

system:admin
</code></pre></div><ol start="3"><li>Confirm that the cluster recognizes the machines:</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc get nodes
</code></pre></div><p><img src="/hpe-solutions-openshift/46-synergy/assets/img/Figure83.cd60438a.png" alt=""></p> <ol start="4"><li>Approve the pending CSRs for your machines</li></ol> <p>When you add machines to a cluster, two pending certificate signing
request (CSRs) are generated for each machine that added. Verify them
if the following command</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc get csr
</code></pre></div><p>Output looks similar to as follows</p> <p><img src="/hpe-solutions-openshift/46-synergy/assets/img/Figure84.aafe9e5e.png" alt=""></p> <p>If they are not approved, approve them manually using the following
command.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc adm certificate approve <span class="token operator">&lt;</span>csr_name<span class="token operator">&gt;</span>
</code></pre></div><ol start="5"><li>Initial Operator configuration</li></ol> <p>In this phase you have to wait up to 15 min to all operators to go to
Available True state. Verify the same using the following command.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">watch</span> -n5 oc get clusteroperators
</code></pre></div><p><img src="/hpe-solutions-openshift/46-synergy/assets/img/Figure85.56a54f30.png" alt=""></p> <ol start="6"><li>Completing installation on user-provisioned infrastructure</li></ol> <p>Once Operator configuration is complete, finish installing the cluster
on infrastructure using the following command and confirm that all
cluster components are online</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> openshift-install --dir<span class="token operator">=</span>./ wait-for install-complete <span class="token operator">|</span> <span class="token function">tee</span>
install-complete
</code></pre></div><p>This will give you an output of you console login with the admin user
and credentials to login similar to as follows</p> <div class="language- extra-class"><pre class="language-text"><code>INFO Waiting up to 30m0s for the cluster at
&lt;https://api.eoffline.twentynet.local:6443&gt; to initialize...

INFO Waiting up to 10m0s for the openshift-console route to be
created...

INFO Install complete!

INFO To access the cluster as the system:admin user when using 'oc',
run 'export
KUBECONFIG=/home/openshift_admin/ignitions/auth/kubeconfig'

INFO Access the OpenShift web-console here:
&lt;https://console-openshift-console.apps.eoffline.twentynet.local&gt;

INFO Login to the console with user: &quot;kubeadmin&quot;, and password:
&quot;xxxxxxxxxxxxxxxx&quot;

INFO Time elapsed: 0s
</code></pre></div><ol start="7"><li>Ensure the cluster nodes are in the ready state using the following
command.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc get nodes
</code></pre></div><p><img src="/hpe-solutions-openshift/46-synergy/assets/img/Figure86.db01bca0.png" alt=""></p> <ol start="8"><li>At this point, Red Hat OpenShift Container Platform cluster is
successfully installed in the restricted network environment and is
available for usage.</li></ol> <h2 id="snapshots"><a href="#snapshots" class="header-anchor">#</a> Snapshots</h2> <p>Once the cluster is installed, operators are not yet available since
there is no connectivity to the internet and the operator related images
are not yet downloaded to the registry server</p> <p><img src="/hpe-solutions-openshift/46-synergy/assets/img/Figure87.53142edf.png" alt=""></p> <p><strong>Figure 87.</strong> Red Hat OpenShift Container Platform</p> <h2 id="setup-centos-servers-to-use-internal-yum-server"><a href="#setup-centos-servers-to-use-internal-yum-server" class="header-anchor">#</a> Setup centos servers to use internal yum server</h2> <ol><li><p>Login to the host as a user with &quot;remove&quot; permission and remove all
the repo files present within the directory /etc/yum.repos.d/.</p></li> <li><p>Login to the server as a non-root user.</p></li> <li><p>Create a new file named local-repo.repo with the following contents.
Update the <em><strong>yum_server_ip_address_or_fqdn</strong></em> field with the IP
address/FQDN of the yum server in your environment</p></li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">vi</span> /etc/yum.repos.d/local-repo.repo
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code> [local-base]

 name=CentOS Base

 baseurl=http://**&lt;yum_server_ip_address_or_fqdn&gt;**/base/

 gpgcheck=0

 enabled=1

 [local-centosplus]

 name=CentOS CentOSPlus

 baseurl=http://**&lt;yum_server_ip_address_or_fqdn&gt;**/centosplus/

 gpgcheck=0

 enabled=1

 [local-extras]

 name=CentOS Extras

 baseurl=http://**&lt;yum_server_ip_address_or_fqdn&gt;**/extras/

 gpgcheck=0

 enabled=1

 [local-updates]

 name=CentOS Updates

 baseurl=http://**&lt;yum_server_ip_address_or_fqdn&gt;**/updates/

 gpgcheck=0

 enabled=1
</code></pre></div><ol start="4"><li>Now the server is ready to use the internal yum server for any
offline package/module installations.</li></ol> <h2 id="using-operator-lifecycle-manager-on-restricted-networks"><a href="#using-operator-lifecycle-manager-on-restricted-networks" class="header-anchor">#</a> Using Operator Lifecycle Manager on Restricted Networks</h2> <p>For OpenShift Container Platform clusters that are installed on
restricted networks, also known as disconnected clusters, Operator
Lifecycle Manager (OLM) by default cannot access the Red Hat-provided
OperatorHub sources hosted remotely on Quay.io because those remote
sources require full Internet connectivity.</p> <p>However, as a cluster administrator you can still enable your cluster to
use OLM in a restricted network if you have a workstation/download
server that has full Internet access. This workstation is used to
prepare local mirrors of the remote OperatorHub sources by pulling the
required remote content. (Similar to the download server as mentioned in
the above steps)</p> <p>An Operator catalog is a repository of metadata that Operator Lifecycle
Manager (OLM) can query to discover and install Operators and their
dependencies on a cluster. OLM always installs Operators from the latest
version of a catalog. As of OpenShift Container Platform 4.6, Red
Hat-provided catalogs are distributed using index images. An index
image, based on the Operator Bundle Format, is a containerized snapshot
of a catalog.</p> <p>There are four Red Hat-provided Operator catalogs:</p> <table><thead><tr><th><strong>Catalog</strong></th> <th><strong>Index image</strong></th> <th><strong>Description</strong></th></tr></thead> <tbody><tr><td>redhat-operators</td> <td>registry.redhat.io/redhat/redhat-operator-index:v4.6</td> <td>Red Hat products packaged and shipped by Red Hat. Supported by Red Hat.</td></tr> <tr><td>certified-operators</td> <td>registry.redhat.io/redhat/certified-operator-index:v4.6</td> <td>Products from leading independent software vendors (ISVs). Red Hat partners with ISVs to package and ship. Supported by the ISV.</td></tr> <tr><td>redhat-marketplace</td> <td>registry.redhat.io/redhat/redhat-marketplace-index:v4.6</td> <td>Certified software that can be purchased from Red Hat Marketplace.</td></tr> <tr><td>community-operators</td> <td>registry.redhat.io/redhat/community-operator-index:latest</td> <td>Software maintained by relevant representatives in the operator-framework/community-operators GitHub repository. No official support.</td></tr></tbody></table> <p>The high-level flow of the procedure is shown below:
<img src="/hpe-solutions-openshift/46-synergy/assets/img/Figure88.db07fb04.png" alt=""> <strong>Figure 88.</strong> Solution Flow of Operator Lifecycle Manager on a
Restricted Network</p> <p>The following is the process that is required to enable OLM in
restricted networks:</p> <p>On the <strong>Download Server</strong> (workstation with Internet Access)</p> <ol><li>Login to registry.redhat.io to pull the required catalog image</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> podman login registry.redhat.io
</code></pre></div><ol start="2"><li>Create directory required for the operators</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">mkdir</span> -p <span class="token variable">${REGISTRY_BASE}</span>/operators
</code></pre></div><ol start="3"><li>Copy the pull secret from the RedHat site into a file in the newly
created directory and validate the same</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">${REGISTRY_BASE}</span>/operators

<span class="token operator">&gt;</span> <span class="token function">cat</span> <span class="token operator">&gt;</span> pull-secret.json <span class="token operator">&lt;&lt;</span> EOF

 <span class="token operator">&lt;</span>Copied-pull-secret<span class="token operator">&gt;</span>

 EOF

<span class="token operator">&gt;</span> <span class="token function">cat</span> pull-secret.json <span class="token operator">|</span> jq
</code></pre></div><ol start="4"><li>Pull the required catalog image</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> podman pull registry.redhat.io/redhat/<span class="token operator">&lt;</span>catalog-image<span class="token operator">&gt;</span>-index:v4.6
</code></pre></div><ol start="5"><li>Save the catalog image into a tar file for use in the mirror
registry</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> podman save <span class="token operator">&lt;</span>image-ID<span class="token operator">&gt;</span> -o <span class="token variable">${REGISTRY_BASE}</span>/operators/<span class="token operator">&lt;</span>catalog-image<span class="token operator">&gt;</span>-catalog.tar
</code></pre></div><ol start="6"><li>The <em>oc adm catalog mirror</em> command extracts the contents of an
index image to generate the manifests required for mirroring. The
following command creates a folder in your current directory.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc adm catalog registry.redhat.io/redhat/<span class="token operator">&lt;</span>catalog-image<span class="token operator">&gt;</span>-index:v4.6
<span class="token operator">&lt;</span>mirror_registry<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span> --manifests-only
--registry-config<span class="token operator">=</span><span class="token variable">${REGISTRY_BASE}</span>/operators/pull-secret.json
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The <em>--manifests-only</em> flag is to only generate the manifests
required for mirroring, but not actually mirror the image content to the
registry yet. This can be useful for reviewing what will be mirrored,
and it allows you to make any changes to the mapping list if you only
require a subset of packages.</p></div> <ol start="7"><li>Navigate to the newly created folder to view the mapping.txt file
and the imageContentSourcePolicy.yaml files</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token operator">&lt;</span>catalog-image<span class="token operator">&gt;</span>-index-manifests

<span class="token operator">&gt;</span> <span class="token function">ls</span> -lrth
</code></pre></div><ol start="8"><li>Identify the required entries for your operator from the mapping.txt
file. Remove the unwanted entries.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">vi</span> mapping.txt
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The entries in the mapping.txt file are in the following format.</p> <p>source_registry/image_url@sha256:digest=mirror_registry/image_url:tag</p></div> <ol start="9"><li>Install the skopeo tool to perform the copy of the images</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> yum <span class="token function">install</span> skopeo -y
</code></pre></div><ol start="10"><li>For each entry in the mapping.txt file copy the images to the local
directory into a custom folder name .</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">${REGISTRY_BASE}</span>/operators

<span class="token operator">&gt;</span> skopeo copy --authfile
 <span class="token variable">${REGISTRY_BASE}</span>/operators/pull-secret.json --all
 docker://<span class="token operator">&lt;</span>source_registry<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>image_url<span class="token operator">&gt;</span>@<span class="token operator">&lt;</span>sha256:digest<span class="token operator">&gt;</span>
 dir:./<span class="token operator">&lt;</span>custom_folder_name_<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span>

<span class="token operator">&gt;</span> skopeo copy --authfile
 <span class="token variable">${REGISTRY_BASE}</span>/operators/pull-secret.json --all
 docker://<span class="token operator">&lt;</span>source_registry<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>image_url<span class="token operator">&gt;</span>@<span class="token operator">&lt;</span>sha256:digest<span class="token operator">&gt;</span>
 dir:./<span class="token operator">&lt;</span>custom_folder_name_<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>

</code></pre></div><p>Do this for all the entries in the mapping.txt file</p> <ol start="11"><li>Tar the contents of the operator folder (
catalog-image-catalog.tar, custom_folder_name_1,
custom_folder_name_2...) to move to the mirror registry</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">tar</span> -zvcf mirror-operator.tar.gz <span class="token operator">&lt;</span>catalog-image<span class="token operator">&gt;</span>-catalog.tar <span class="token operator">&lt;</span>custom_folder_name_<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> <span class="token operator">&lt;</span>custom_folder_name_<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token punctuation">..</span>.
</code></pre></div><ol start="12"><li>Tar the contents of the catalog-image-index-manifests folder to
move to the installer machine.</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token operator">&lt;</span>catalog-image<span class="token operator">&gt;</span>-index-manifests

<span class="token operator">&gt;</span> <span class="token function">tar</span> -zvcf installer-operator.tar.gz *
</code></pre></div><p>On the <strong>Mirror Server</strong> (Restricted Network)</p> <ol start="13"><li>Untar the mirror-operator.tar.gz file</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token variable">${REGISTRY_BASE}</span>/operators

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">tar</span> -xvf /path/to/mirror-operator.tar.gz -C
<span class="token operator">&gt;</span> <span class="token variable">${REGISTRY_BASE}</span>/operators/
</code></pre></div><ol start="14"><li>Login to your mirror registry to push new images</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> podman login <span class="token operator">&lt;</span>mirror_registry<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span>
</code></pre></div><ol start="15"><li>Load the required catalog image and validate the same</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">${REGISTRY_BASE}</span>/operators

<span class="token operator">&gt;</span> <span class="token function">sudo</span> podman load -i <span class="token operator">&lt;</span>catalog-image<span class="token operator">&gt;</span>-catalog.tar

<span class="token operator">&gt;</span> <span class="token function">sudo</span> podman images
</code></pre></div><ol start="16"><li>Push the catalog image to the mirror registry</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> podman push <span class="token operator">&lt;</span>catalog_image_tag<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>mirror_registry<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>port<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>namespace<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>catalog_image<span class="token operator">&gt;</span>-index:v4.6
</code></pre></div><ol start="17"><li>Install the skopeo tool to perform a copy of the images</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> yum <span class="token function">install</span> skopeo -y
</code></pre></div><ol start="18"><li>Transfer the images from your director into the mirror registry</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> skopeo copy --authfile
 <span class="token variable">${REGISTRY_BASE}</span>/downloads/secrets/pull-secret-registry.json --all
 dir:./ <span class="token operator">&lt;</span>custom_folder_name_<span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span> docker://<span class="token operator">&lt;</span>mirror registry<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>image
 url<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>tag<span class="token operator">&gt;</span>

<span class="token operator">&gt;</span> skopeo copy --authfile
 <span class="token variable">${REGISTRY_BASE}</span>/downloads/secrets/pull-secret-registry.json --all
 dir:./ <span class="token operator">&lt;</span>custom_folder_name_<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> docker://<span class="token operator">&lt;</span>mirror registry<span class="token operator">&gt;</span>/<span class="token operator">&lt;</span>image
 url<span class="token operator">&gt;</span>:<span class="token operator">&lt;</span>tag<span class="token operator">&gt;</span>

</code></pre></div><p>Do this for all the directory folders you have by referring the
mapping.txt for the corresponding tags.</p> <p>For the <strong>Installer Server</strong> (Restricted Network)</p> <ol start="19"><li>Disable the sources for the default catalogs by adding
disableAllDefaultSources: true to the OperatorHub spec:</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc patch OperatorHub cluster --type json <span class="token punctuation">\</span>
-p <span class="token string">'[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/spec/disableAllDefaultSources&quot;,
&quot;value&quot;: true}]'</span>
</code></pre></div><ol start="20"><li>Untar the installer-operator.tar.gz file</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token variable">${REGISTRY_BASE}</span>/operators

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">tar</span> -xvf /path/to/mirror-operator.tar.gz -C
 <span class="token variable">${REGISTRY_BASE}</span>/operators/
</code></pre></div><ol start="21"><li>Create the CatalogSource.yaml file</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token builtin class-name">cd</span> <span class="token variable">${REGISTRY_BASE}</span>/operators

<span class="token operator">&gt;</span> <span class="token function">sudo</span> <span class="token function">vi</span> CatalogSource.yaml
</code></pre></div><p>Paste the following content: (Refer to instruction 16 for the catalog
image)</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> operators.coreos.com/v1alpha1

<span class="token key atrule">kind</span><span class="token punctuation">:</span> CatalogSource

<span class="token key atrule">metadata</span><span class="token punctuation">:</span>

  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>operator<span class="token punctuation">-</span>catalog

  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> openshift<span class="token punctuation">-</span>marketplace

<span class="token key atrule">spec</span><span class="token punctuation">:</span>

  <span class="token key atrule">sourceType</span><span class="token punctuation">:</span> grpc

  <span class="token key atrule">image</span><span class="token punctuation">:</span> &lt;registry_mirror<span class="token punctuation">&gt;</span><span class="token punctuation">:</span>&lt;port<span class="token punctuation">&gt;</span>/&lt;namespace<span class="token punctuation">&gt;</span>/&lt;catalog_image<span class="token punctuation">&gt;</span><span class="token punctuation">-</span>index<span class="token punctuation">:</span>v4.6

  <span class="token key atrule">displayName</span><span class="token punctuation">:</span> My Operator Catalog

  <span class="token key atrule">publisher</span><span class="token punctuation">:</span> &lt;custom_publisher_name<span class="token punctuation">&gt;</span>
</code></pre></div><ol start="22"><li>Verify the following resources are created successfully</li></ol> <p><strong>Check the pods:</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc get pods -n openshift-marketplace
</code></pre></div><p>Example Output:</p> <div class="language- extra-class"><pre class="language-text"><code> NAME READY STATUS RESTARTS AGE

 my-operator-catalog-6njx6 1/1 Running 0 28s

 marketplace-operator-d9f549946-96sgr 1/1 Running 0 26h
</code></pre></div><p><strong>Check the CatalogSource</strong>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc get catalogsource -n openshift-marketplace
</code></pre></div><p>Example Output:</p> <div class="language- extra-class"><pre class="language-text"><code> NAME DISPLAY TYPE PUBLISHER AGE

 my-operator-catalog My Operator Catalog grpc 5s
</code></pre></div><p><strong>Check the PackageManifest:</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc get packagemanifest -n openshift-marketplace
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code> Example Output:

 NAME CATALOG AGE

 jaeger-product My Operator Catalog 93s
</code></pre></div><ol start="23"><li>Apply the imageContentSourcePolicy.yaml file ( any further new
entries for new operators can be appended to the existing yaml file)</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> oc create -f imageContentSourcePolicy.yaml
</code></pre></div><ol start="24"><li>Wait for the Image Content Source Policy to apply to all the nodes
in the cluster</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">watch</span> oc get nodes
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The nodes will go from Ready to NotReady and Scheduling Disabled
states.</p> <p>Wait for all the nodes to get back to Ready state</p></div> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&gt;</span> <span class="token function">watch</span> oc get mcp
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Wait for the UPDATED states of both the master and worker to turn to
True</p></div> <ol start="25"><li><p>Login to OpenShift Console</p></li> <li><p>Install the newly pushed Operator in required namespace</p></li> <li><p>Deploy instance as required</p></li> <li><p>Repeat above steps for other required operators.</p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/IPI-Installation.html" class="prev">
        IPI deployment of OCP on Bare Metal
      </a></span> <span class="next"><a href="/hpe-solutions-openshift/46-synergy/Additional-Features-and-Functionality/OpenShift-operators.html">
        OpenShift operators
      </a>
      
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/hpe-solutions-openshift/46-synergy/assets/js/app.8d09024b.js" defer></script><script src="/hpe-solutions-openshift/46-synergy/assets/js/2.117ef8fd.js" defer></script><script src="/hpe-solutions-openshift/46-synergy/assets/js/11.eb22f408.js" defer></script>
  </body>
</html>
